<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation Timer - Vivify</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        footer {
            background-color: #000;
            color: white;
            text-align: center;
            padding: 2rem 0;
            width: 100%;
            margin-top: auto;
            border-top: 1px solid #333;
        }

        footer .footer-links {
            list-style: none;
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin: 1rem 0 0 0;
            padding: 0;
        }

        footer .footer-links a {
            color: #a0a0a0;
            text-decoration: none;
            transition: color 0.3s;
        }

        footer .footer-links a:hover {
            color: #f39c12;
        }
        
        .meditation-hero {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), 
                        url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&w=1920&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 6rem 2rem 4rem 2rem;
            text-align: center;
        }

        .meditation-hero h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .meditation-hero p {
            font-size: 1.25rem;
            max-width: 800px;
            margin: 0 auto 2rem;
        }
        
        .timer-container {
            max-width: 800px;
            margin: -4rem auto 3rem auto;
            background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            position: relative;
            z-index: 10;
        }

        .timer-display {
            text-align: center;
            margin-bottom: 3rem;
        }

        .time-circle {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 2rem;
            background: #333;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                inset 0 0 20px rgba(0, 0, 0, 0.5),
                0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .time-circle::before {
            content: '';
            position: absolute;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: conic-gradient(
                #f39c12 0deg,
                #f39c12 var(--progress, 0deg),
                #444 var(--progress, 0deg),
                #444 360deg
            );
            z-index: 1;
        }

        .time-circle::after {
            content: '';
            position: absolute;
            width: 240px;
            height: 240px;
            background: linear-gradient(145deg, #1e1e1e, #2a2a2a);
            border-radius: 50%;
            z-index: 2;
        }

        .time-text {
            position: relative;
            z-index: 3;
            font-size: 3.5rem;
            font-weight: 300;
            color: #f39c12;
            text-shadow: 0 0 20px rgba(243, 156, 18, 0.3);
        }

        .timer-status {
            font-size: 1.25rem;
            color: #aaa;
            margin-bottom: 1rem;
        }

        .session-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .preset-btn {
            background: #333;
            color: white;
            border: 2px solid #444;
            border-radius: 10px;
            padding: 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .preset-btn:hover {
            background: #444;
            border-color: #f39c12;
            transform: translateY(-2px);
        }

        .preset-btn.active {
            background: #f39c12;
            color: #000;
            border-color: #f39c12;
        }

        .preset-btn i {
            font-size: 1.5rem;
        }

        .custom-time {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .time-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #333;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 2px solid #444;
            transition: border-color 0.3s;
            height: 50px; /* Fixed height for consistent alignment */
        }

        .time-input input {
            background: transparent;
            border: none;
            color: white;
            width: 60px;
            text-align: center;
            font-size: 1.2rem;
            outline: none;
            height: 100%;
            line-height: 1;
            padding: 0; /* Remove any default padding */
            margin: 0; /* Remove any default margins */
            vertical-align: middle; /* Force vertical alignment */
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-input label {
            color: #aaa;
            font-size: 1.2rem; /* Match input font size exactly */
            line-height: 1;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            height: 100%;
            vertical-align: middle;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-btn {
            background: #f39c12;
            color: #000;
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 120px;
            justify-content: center;
        }

        .control-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(243, 156, 18, 0.3);
        }

        .control-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .control-btn.secondary {
            background: #555;
            color: white;
        }

        .control-btn.secondary:hover {
            background: #666;
        }

        .sound-controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .sound-controls h3 {
            color: #f39c12;
            margin-bottom: 1rem;
            text-align: center;
        }

        .sound-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .sound-option {
            background: #333;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sound-option:hover {
            border-color: #f39c12;
        }

        .sound-option.active {
            background: #f39c12;
            color: #000;
            border-color: #f39c12;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .volume-slider {
            width: 200px;
            height: 6px;
            background: #444;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #f39c12;
            border-radius: 50%;
            cursor: pointer;
        }

        .session-complete {
            display: none;
            text-align: center;
            background: linear-gradient(145deg, #27ae60, #2ecc71);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-top: 2rem;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .session-complete.show {
            display: block;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .guided-meditations {
            background: #222;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 3rem;
        }

        .guided-meditations h2 {
            color: #f39c12;
            text-align: center;
            margin-bottom: 2rem;
        }

        .meditation-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .meditation-card {
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .meditation-card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: black;
            padding: 1rem;
            text-align: center;
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-content h4 {
            color: #f39c12;
            margin-bottom: 0.5rem;
        }

        .card-content p {
            color: #ddd;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .duration-badge {
            background: #f39c12;
            color: black;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .meditation-hero h1 {
                font-size: 2.5rem;
            }
            
            .timer-container {
                margin: -2rem 1rem 2rem 1rem;
                padding: 2rem;
            }
            
            .time-circle {
                width: 250px;
                height: 250px;
            }
            
            .time-circle::before {
                width: 230px;
                height: 230px;
            }
            
            .time-circle::after {
                width: 200px;
                height: 200px;
            }
            
            .time-text {
                font-size: 2.5rem;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .custom-time {
                flex-direction: column;
            }
            
            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <header>
            <nav>
                <div class="left-nav">
                    <div class="logo">
                        <a href="index.html" aria-label="Home Page"><h1>Vivify</h1></a>
                    </div>
                    <ul>
                        <li><a href="about.html" aria-label="About Us Page">About</a></li>
                        <li class="dropdown" id="categoryDropdown">
                            <a href="#" class="dropbtn" aria-label="Categories Dropdown">Categories</a>
                            <div class="dropdown-content">
                                <a href="fitness.html" aria-label="Fitness Page">Fitness</a>
                                <a href="nutrition.html" aria-label="Nutrition Page">Nutrition</a>
                                <a href="mental-health.html" aria-label="Mental Health Page">Mental Health</a>
                                <a href="life-lessons.html" aria-label="Life Lessons Page">Life Lessons</a>
                            </div>
                        </li>
                    </ul>
                </div>
                <div class="right-nav">
                    <ul>
                        <li><a href="dashboard.html" id="dashboardLink" aria-label="Dashboard">Dashboard</a></li>
                        <li><a href="profile.html" id="profileLink" aria-label="Profile Page">Profile</a></li>
                        <li><a href="#" id="logoutLink" aria-label="Logout">Logout</a></li>
                        <li><a href="login.html" id="loginLink" style="display: none;" aria-label="Login Page">Login</a></li>
                        <li><a href="signup.html" id="signupLink" style="display: none;" aria-label="Sign Up Page">Sign Up</a></li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Hero Section -->
        <section class="meditation-hero">
            <h1>Meditation Timer</h1>
            <p>Take a moment to centre yourself and practice mindfulness. Choose your duration and let our timer guide you through a peaceful meditation session.</p>
        </section>

        <!-- Timer Container -->
        <main class="timer-container">
            <!-- Timer Display -->
            <div class="timer-display">
                <div class="time-circle" id="timeCircle">
                    <div class="time-text" id="timeText">05:00</div>
                </div>
                <div class="timer-status" id="timerStatus">Ready to begin</div>
                <div class="session-info" id="sessionInfo">
                    <span>Selected: <strong id="selectedDuration">5 minutes</strong></span>
                    <span> | Sessions today: <strong id="sessionsToday">0</strong></span>
                </div>
            </div>

            <!-- Preset Time Buttons -->
            <div class="preset-buttons">
                <button class="preset-btn active" data-minutes="5">
                    <i class="fas fa-seedling"></i>
                    <span>5 min</span>
                    <small>Beginner</small>
                </button>
                <button class="preset-btn" data-minutes="10">
                    <i class="fas fa-leaf"></i>
                    <span>10 min</span>
                    <small>Focus</small>
                </button>
                <button class="preset-btn" data-minutes="15">
                    <i class="fas fa-tree"></i>
                    <span>15 min</span>
                    <small>Mindful</small>
                </button>
                <button class="preset-btn" data-minutes="20">
                    <i class="fas fa-mountain"></i>
                    <span>20 min</span>
                    <small>Deep</small>
                </button>
                <button class="preset-btn" data-minutes="30">
                    <i class="fas fa-sun"></i>
                    <span>30 min</span>
                    <small>Extended</small>
                </button>
            </div>

            <!-- Custom Time Input -->
            <div class="custom-time">
                <span style="color: #f39c12; margin-right: 1rem;">Custom Duration:</span>
                <div class="time-input">
                    <input type="number" id="customMinutes" min="1" max="99" value="5">
                    <label>minutes</label>
                </div>
                <button class="preset-btn" onclick="setCustomTime()">
                    <i class="fas fa-clock"></i>
                    Set
                </button>
            </div>

            <!-- Control Buttons -->
            <div class="control-buttons">
                <button class="control-btn" id="startBtn" onclick="startTimer()">
                    <i class="fas fa-play"></i>
                    Start
                </button>
                <button class="control-btn secondary" id="pauseBtn" onclick="pauseTimer()" disabled>
                    <i class="fas fa-pause"></i>
                    Pause
                </button>
                <button class="control-btn secondary" id="resetBtn" onclick="resetTimer()">
                    <i class="fas fa-stop"></i>
                    Reset
                </button>
            </div>

            <!-- Sound Controls -->
            <div class="sound-controls">
                <h3><i class="fas fa-volume-up"></i> Ambient Sounds</h3>
                <div class="sound-options">
                    <div class="sound-option active" data-sound="none">
                        <i class="fas fa-volume-mute"></i>
                        <div>Silence</div>
                    </div>
                    <div class="sound-option" data-sound="rain">
                        <i class="fas fa-cloud-rain"></i>
                        <div>Rain</div>
                    </div>
                    <div class="sound-option" data-sound="ocean">
                        <i class="fas fa-water"></i>
                        <div>Ocean Waves</div>
                    </div>
                    <div class="sound-option" data-sound="forest">
                        <i class="fas fa-tree"></i>
                        <div>Forest</div>
                    </div>
                    <div class="sound-option" data-sound="bells">
                        <i class="fas fa-bell"></i>
                        <div>Tibetan Bowls</div>
                    </div>
                </div>
                <div class="volume-control">
                    <i class="fas fa-volume-down"></i>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="0.8">
                    <i class="fas fa-volume-up"></i>
                </div>
            </div>

            <!-- Session Complete -->
            <div class="session-complete" id="sessionComplete">
                <h2><i class="fas fa-check-circle"></i> Well Done!</h2>
                <p>You've completed your meditation session. Take a moment to notice how you feel.</p>
                <div class="session-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="completedDuration">5</div>
                        <div class="stat-label">Minutes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalSessions">1</div>
                        <div class="stat-label">Today</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="streakCount">1</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
                <button class="control-btn" onclick="startNewSession()">
                    <i class="fas fa-redo"></i>
                    Start New Session
                </button>
            </div>
        </main>

        <!-- Guided Meditations -->
        <section class="guided-meditations">
            <h2>Guided Meditations for Students</h2>
            <div class="meditation-cards">
                <div class="meditation-card">
                    <div class="card-header">
                        <i class="fas fa-graduation-cap"></i>
                        <strong>Exam Stress Relief</strong>
                        <span class="duration-badge">10 min</span>
                    </div>
                    <div class="card-content">
                        <h4>Reduce Exam Anxiety</h4>
                        <p>A calming meditation designed specifically for students dealing with exam stress and performance anxiety.</p>
                        <button class="control-btn" onclick="startGuidedMeditation(10, 'exam-stress')">
                            <i class="fas fa-play"></i>
                            Start Session
                        </button>
                    </div>
                </div>

                <div class="meditation-card">
                    <div class="card-header">
                        <i class="fas fa-brain"></i>
                        <strong>Focus & Concentration</strong>
                        <span class="duration-badge">15 min</span>
                    </div>
                    <div class="card-content">
                        <h4>Improve Study Focus</h4>
                        <p>Enhance your ability to concentrate and maintain attention during study sessions and classes.</p>
                        <button class="control-btn" onclick="startGuidedMeditation(15, 'focus')">
                            <i class="fas fa-play"></i>
                            Start Session
                        </button>
                    </div>
                </div>

                <div class="meditation-card">
                    <div class="card-header">
                        <i class="fas fa-bed"></i>
                        <strong>Better Sleep</strong>
                        <span class="duration-badge">20 min</span>
                    </div>
                    <div class="card-content">
                        <h4>Peaceful Night's Rest</h4>
                        <p>A relaxing meditation to help you unwind after a busy day and prepare for restful sleep.</p>
                        <button class="control-btn" onclick="startGuidedMeditation(20, 'sleep')">
                            <i class="fas fa-play"></i>
                            Start Session
                        </button>
                    </div>
                </div>

                <div class="meditation-card">
                    <div class="card-header">
                        <i class="fas fa-heart"></i>
                        <strong>Self-Compassion</strong>
                        <span class="duration-badge">12 min</span>
                    </div>
                    <div class="card-content">
                        <h4>Be Kind to Yourself</h4>
                        <p>Learn to treat yourself with kindness and develop a healthier relationship with your inner critic.</p>
                        <button class="control-btn" onclick="startGuidedMeditation(12, 'self-compassion')">
                            <i class="fas fa-play"></i>
                            Start Session
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer>
            <p>&copy; 2024 Vivify. All rights reserved.</p>
            <ul class="footer-links">
                <li><a href="privacy.html" aria-label="Privacy Policy">Privacy Policy</a></li>
                <li><a href="terms.html" aria-label="Terms of Service">Terms of Service</a></li>
                <li><a href="contact.html" aria-label="Contact Us">Contact Us</a></li>
            </ul>
        </footer>
    </div>

    <script>
        console.log('üéµ Meditation Timer with Working Audio Starting...');

        // Global variables
        let audioContext = null;
        let currentAmbientSound = null;
        let volume = 0.8;
        let selectedSound = 'none';
        let isAudioEnabled = false;

        // Timer variables
        let duration = 5 * 60;
        let timeLeft = duration;
        let isRunning = false;
        let isPaused = false;
        let timerInterval = null;
        let sessionsToday = 0;
        let currentGuidedType = null;

        // DOM elements
        const timeText = document.getElementById('timeText');
        const timeCircle = document.getElementById('timeCircle');
        const timerStatus = document.getElementById('timerStatus');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const sessionComplete = document.getElementById('sessionComplete');

        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('üéµ Audio context created');
                isAudioEnabled = true;
            }
        }

        // File-based audio system
        function createAmbientAudio(soundType) {
            console.log('üéµ Loading audio file:', soundType);
            
            const audio = new Audio();
            audio.src = `sounds/${soundType}.mp3`;
            audio.loop = true;
            audio.volume = volume * 0.7;
            
            // Add event listeners for debugging
            audio.addEventListener('loadstart', () => {
                console.log('üìÅ Started loading:', soundType);
            });
            
            audio.addEventListener('canplay', () => {
                console.log('‚úÖ Audio file ready:', soundType);
            });
            
            audio.addEventListener('error', (e) => {
                console.error('‚ùå Audio file error:', soundType, e);
                console.log('üí° Make sure you have:', `sounds/${soundType}.mp3`);
            });
            
            return audio;
        }

        function startAmbientSound() {
            if (selectedSound === 'none') {
                console.log('üîá No sound selected');
                return;
            }

            console.log('üéµ Starting ambient sound:', selectedSound);
            stopAmbientSound();

            try {
                // Try to load audio file first
                currentAmbientSound = createAmbientAudio(selectedSound);
                
                if (currentAmbientSound) {
                    currentAmbientSound.play().then(() => {
                        console.log('‚úÖ Audio file playing:', selectedSound);
                    }).catch((error) => {
                        console.error('‚ùå Audio play failed, falling back to generated sound:', error);
                        // Fallback to generated sounds if file fails
                        fallbackToGeneratedSound();
                    });
                }
            } catch (error) {
                console.error('‚ùå Error with audio file, using generated sound:', error);
                fallbackToGeneratedSound();
            }
        }

        function fallbackToGeneratedSound() {
            console.log('üîÑ Using generated sound as fallback');
            
            // Initialize audio context if needed
            if (!audioContext) {
                initAudio();
            }
            
            let generatedSound = null;
            
            switch (selectedSound) {
                case 'rain':
                    generatedSound = createGeneratedRain();
                    break;
                case 'ocean':
                    generatedSound = createGeneratedOcean();
                    break;
                case 'forest':
                    generatedSound = createGeneratedForest();
                    break;
                case 'bells':
                    generatedSound = createGeneratedBells();
                    break;
            }
            
            if (generatedSound && generatedSound.source) {
                generatedSound.source.start();
                currentAmbientSound = generatedSound;
                console.log('‚úÖ Generated sound started');
            }
        }

        function stopAmbientSound() {
            if (currentAmbientSound) {
                try {
                    if (currentAmbientSound.pause) {
                        // It's an HTML5 Audio element
                        currentAmbientSound.pause();
                        currentAmbientSound.currentTime = 0;
                        console.log('üõë Audio file stopped');
                    } else if (currentAmbientSound.source) {
                        // It's a Web Audio API source
                        currentAmbientSound.source.stop();
                        console.log('üõë Generated sound stopped');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Error stopping sound:', error.message);
                }
                currentAmbientSound = null;
            }
        }

        // Generated sound fallbacks (keep the old functions but rename them)
        function createGeneratedRain() {
            if (!audioContext) return null;
            const bufferSize = audioContext.sampleRate * 2;
            const buffer = audioContext.createBuffer(2, bufferSize, audioContext.sampleRate);
            const leftData = buffer.getChannelData(0);
            const rightData = buffer.getChannelData(1);
            
            for (let i = 0; i < bufferSize; i++) {
                leftData[i] = (Math.random() * 2 - 1) * 0.3;
                rightData[i] = (Math.random() * 2 - 1) * 0.3;
            }

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 1500;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume * 0.7;
            source.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            return { source, gainNode };
        }

        function createGeneratedOcean() {
            if (!audioContext) return null;
            const bufferSize = audioContext.sampleRate * 3;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                const time = i / audioContext.sampleRate;
                data[i] = (Math.sin(2 * Math.PI * 0.3 * time) * 0.4 + Math.sin(2 * Math.PI * 0.5 * time) * 0.3 + (Math.random() * 2 - 1) * 0.1) * 0.5;
            }

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume * 0.6;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            return { source, gainNode };
        }

        function createGeneratedForest() {
            if (!audioContext) return null;
            const bufferSize = audioContext.sampleRate * 2;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                const time = i / audioContext.sampleRate;
                data[i] = (Math.sin(2 * Math.PI * 0.4 * time) * 0.2 + (Math.random() * 2 - 1) * 0.15) * 0.4;
            }

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume * 0.5;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            return { source, gainNode };
        }

        function createGeneratedBells() {
            if (!audioContext) return null;
            const bufferSize = audioContext.sampleRate * 4;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < bufferSize; i++) {
                const time = i / audioContext.sampleRate;
                data[i] = (Math.sin(2 * Math.PI * 220 * time) * Math.exp(-time * 0.5) * 0.6 + Math.sin(2 * Math.PI * 440 * time) * Math.exp(-time * 0.7) * 0.3) * 0.5;
            }

            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.loop = true;
            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume * 0.4;
            source.connect(gainNode);
            gainNode.connect(audioContext.destination);
            return { source, gainNode };
        }

       // Timer functions
       function updateDisplay() {
           const minutes = Math.floor(timeLeft / 60);
           const seconds = timeLeft % 60;
           timeText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

           const progress = ((duration - timeLeft) / duration) * 360;
           timeCircle.style.setProperty('--progress', `${progress}deg`);
       }

       function updateSessionInfo() {
           const totalMinutes = Math.floor(duration / 60);
           document.getElementById('selectedDuration').textContent = `${totalMinutes} minute${totalMinutes !== 1 ? 's' : ''}`;
           document.getElementById('sessionsToday').textContent = sessionsToday;
       }

       function startTimer() {
           console.log('‚ñ∂Ô∏è Starting timer...');
           
           // Initialize audio on first user interaction
           initAudio();
           
           if (isPaused) {
               resumeTimer();
               return;
           }

           isRunning = true;
           isPaused = false;
           startBtn.disabled = true;
           pauseBtn.disabled = false;
           timerStatus.textContent = 'Meditating...';

           // Ensure audio context is resumed (required by some browsers)
           if (audioContext && audioContext.state === 'suspended') {
               audioContext.resume().then(() => {
                   startAmbientSound();
               });
           } else {
               startAmbientSound();
           }

           timerInterval = setInterval(() => {
               timeLeft--;
               updateDisplay();

               if (timeLeft <= 0) {
                   completeSession();
               }
           }, 1000);

           // Track activity if available
           if (typeof window.vivifyTracker !== 'undefined') {
               window.vivifyTracker.trackMeditationStart();
           }
       }

       function pauseTimer() {
           console.log('‚è∏Ô∏è Pausing timer...');
           
           isPaused = true;
           isRunning = false;
           clearInterval(timerInterval);
           startBtn.disabled = false;
           pauseBtn.disabled = true;
           timerStatus.textContent = 'Paused';

           stopAmbientSound();
       }

       function resumeTimer() {
           console.log('‚ñ∂Ô∏è Resuming timer...');
           
           isRunning = true;
           isPaused = false;
           startBtn.disabled = true;
           pauseBtn.disabled = false;
           timerStatus.textContent = 'Meditating...';

           // Ensure audio context is resumed
           if (audioContext && audioContext.state === 'suspended') {
               audioContext.resume().then(() => {
                   startAmbientSound();
               });
           } else {
               startAmbientSound();
           }

           timerInterval = setInterval(() => {
               timeLeft--;
               updateDisplay();

               if (timeLeft <= 0) {
                   completeSession();
               }
           }, 1000);
       }

       function resetTimer() {
           console.log('üîÑ Resetting timer...');
           
           isRunning = false;
           isPaused = false;
           clearInterval(timerInterval);
           timeLeft = duration;
           startBtn.disabled = false;
           pauseBtn.disabled = true;
           timerStatus.textContent = 'Ready to begin';
           sessionComplete.classList.remove('show');

           stopAmbientSound();
           updateDisplay();
       }

       function completeSession() {
           console.log('‚úÖ Session complete!');
           
           isRunning = false;
           isPaused = false;
           clearInterval(timerInterval);
           startBtn.disabled = false;
           pauseBtn.disabled = true;
           timerStatus.textContent = 'Session complete! Well done!';

           stopAmbientSound();
           
           // Play completion sound
           if (audioContext) {
               const oscillator = audioContext.createOscillator();
               const gainNode = audioContext.createGain();
               
               oscillator.connect(gainNode);
               gainNode.connect(audioContext.destination);
               
               oscillator.frequency.value = 800;
               gainNode.gain.setValueAtTime(0.6, audioContext.currentTime);
               gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5);
               
               oscillator.start();
               oscillator.stop(audioContext.currentTime + 1.5);
           }

           recordSession();
           showSessionComplete();

           // Track completion if available
           if (typeof window.vivifyTracker !== 'undefined') {
               window.vivifyTracker.trackMeditationComplete();
           }
       }

       function recordSession() {
           sessionsToday++;
           const today = new Date().toDateString();
           
           const sessionData = {
               date: today,
               duration: Math.floor(duration / 60),
               type: currentGuidedType || 'timer',
               completedAt: new Date().toISOString()
           };

           let sessions = JSON.parse(localStorage.getItem('meditationSessions') || '[]');
           sessions.push(sessionData);
           localStorage.setItem('meditationSessions', JSON.stringify(sessions));

           localStorage.setItem('meditationSessionsToday', sessionsToday.toString());
           localStorage.setItem('lastMeditationDate', today);
       }

       function getTodaySessions() {
           const today = new Date().toDateString();
           const lastDate = localStorage.getItem('lastMeditationDate');
           
           if (lastDate === today) {
               return parseInt(localStorage.getItem('meditationSessionsToday') || '0');
           } else {
               localStorage.setItem('meditationSessionsToday', '0');
               localStorage.setItem('lastMeditationDate', today);
               return 0;
           }
       }

       function showSessionComplete() {
           const completedMinutes = Math.floor(duration / 60);
           document.getElementById('completedDuration').textContent = completedMinutes;
           document.getElementById('totalSessions').textContent = sessionsToday;
           
           const streak = 1; // Simplified - could be enhanced with actual streak calculation
           document.getElementById('streakCount').textContent = streak;
           
           sessionComplete.classList.add('show');
           sessionComplete.scrollIntoView({ behavior: 'smooth' });
       }

       function setCustomTime() {
           if (isRunning) return;
           
           const minutes = parseInt(document.getElementById('customMinutes').value);
           if (minutes && minutes > 0) {
               duration = minutes * 60;
               timeLeft = duration;
               clearActivePresets();
               updateDisplay();
               updateSessionInfo();
           }
       }

       function clearActivePresets() {
           document.querySelectorAll('.preset-btn[data-minutes]').forEach(btn => {
               btn.classList.remove('active');
           });
       }

       function startNewSession() {
           resetTimer();
           currentGuidedType = null;
           timerStatus.textContent = 'Ready to begin';
       }

       function startGuidedMeditation(minutes, type) {
           currentGuidedType = type;
           duration = minutes * 60;
           timeLeft = duration;
           clearActivePresets();
           updateDisplay();
           updateSessionInfo();
           
           timerStatus.textContent = `Guided: ${getGuidedTitle(type)}`;
           
           document.querySelector('.timer-container').scrollIntoView({ 
               behavior: 'smooth' 
           });
       }

       function getGuidedTitle(type) {
           const titles = {
               'exam-stress': 'Exam Stress Relief',
               'focus': 'Focus & Concentration',
               'sleep': 'Better Sleep',
               'self-compassion': 'Self-Compassion'
           };
           return titles[type] || 'Guided Meditation';
       }

       // Event listeners
       document.addEventListener('DOMContentLoaded', function() {
           console.log('üì± Loading meditation timer...');
           
           // Auth handling
           const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
           document.getElementById('loginLink').style.display = isLoggedIn ? 'none' : 'inline';
           document.getElementById('signupLink').style.display = isLoggedIn ? 'none' : 'inline';
           document.getElementById('logoutLink').style.display = isLoggedIn ? 'inline' : 'none';
           document.getElementById('profileLink').style.display = isLoggedIn ? 'inline' : 'none';
           document.getElementById('dashboardLink').style.display = isLoggedIn ? 'inline' : 'none';
           
           document.getElementById('logoutLink').addEventListener('click', function(e) {
               e.preventDefault();
               localStorage.removeItem('userLoggedIn');
               localStorage.removeItem('authToken');
               window.location.href = 'index.html';
           });

           // Load sessions today
           sessionsToday = getTodaySessions();

           // Preset buttons
           document.querySelectorAll('.preset-btn[data-minutes]').forEach(btn => {
               btn.addEventListener('click', () => {
                   if (isRunning) return;
                   
                   const minutes = parseInt(btn.dataset.minutes);
                   duration = minutes * 60;
                   timeLeft = duration;
                   
                   document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                   btn.classList.add('active');
                   
                   updateDisplay();
                   updateSessionInfo();
                   console.log('‚è±Ô∏è Duration set to', minutes, 'minutes');
               });
           });

           // Sound option buttons
           document.querySelectorAll('.sound-option').forEach(option => {
               option.addEventListener('click', () => {
                   // Initialize audio on first sound selection
                   initAudio();
                   
                   document.querySelectorAll('.sound-option').forEach(opt => opt.classList.remove('active'));
                   option.classList.add('active');
                   selectedSound = option.dataset.sound;
                   console.log('üéµ Sound selected:', selectedSound);

                   // If timer is running, restart ambient sound
                   if (isRunning) {
                       stopAmbientSound();
                       startAmbientSound();
                   }
               });
           });

           // Volume control (find this section and replace it)
           document.getElementById('volumeSlider').addEventListener('input', (e) => {
                volume = parseFloat(e.target.value);
                console.log('üîä Volume changed to:', volume);
                
                if (currentAmbientSound) {
                    if (currentAmbientSound.volume !== undefined) {
                        // HTML5 Audio element
                        currentAmbientSound.volume = volume * 0.7;
                    } else if (currentAmbientSound.gainNode) {
                        // Web Audio API
                        currentAmbientSound.gainNode.gain.value = volume * 0.7;
                    }
                }
            });

           // Custom time input
           document.getElementById('customMinutes').addEventListener('change', () => {
               clearActivePresets();
           });

           // Initialize display
           updateDisplay();
           updateSessionInfo();
           
           console.log('‚úÖ Meditation timer ready!');
       });

       // Keyboard shortcuts
       document.addEventListener('keydown', function(e) {
           if (e.target.matches('input')) return;
           
           switch(e.code) {
               case 'Space':
                   e.preventDefault();
                   if (!isRunning && !isPaused) {
                       startTimer();
                   } else if (isRunning) {
                       pauseTimer();
                   } else if (isPaused) {
                       startTimer();
                   }
                   break;
                   
               case 'KeyR':
                   e.preventDefault();
                   resetTimer();
                   break;
                   
               case 'Digit1':
                   e.preventDefault();
                   if (!isRunning) {
                       document.querySelector('[data-minutes="5"]').click();
                   }
                   break;
                   
               case 'Digit2':
                   e.preventDefault();
                   if (!isRunning) {
                       document.querySelector('[data-minutes="10"]').click();
                   }
                   break;
                   
               case 'Digit3':
                   e.preventDefault();
                   if (!isRunning) {
                       document.querySelector('[data-minutes="15"]').click();
                   }
                   break;
           }
       });

       console.log('üéØ Meditation timer loaded and ready!');
       console.log('üéµ Select an ambient sound and start your meditation!');
   </script>
</body>
</html>