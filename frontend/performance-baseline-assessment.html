<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Baseline Assessment - Vivify</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            padding-top: 80px;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            width: 100%;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo a {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        /* Assessment Container */
        .assessment-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background: linear-gradient(145deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 20px;
            border: 1px solid #333;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .assessment-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .performance-badge {
            display: inline-block;
            background: rgba(255, 107, 53, 0.1);
            color: #ff6b35;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2rem;
        }

        .assessment-header h1 {
            color: #ff6b35;
            margin-bottom: 1rem;
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .assessment-header p {
            color: #ccc;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .assessment-header .subtitle {
            color: #888;
            font-size: 0.95rem;
            background: rgba(255, 107, 53, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-block;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }

        /* Progress */
        .progress-container {
            margin-bottom: 3rem;
            background: #222;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #333;
        }

        .progress-text {
            color: #ff6b35;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .progress-bar {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Question Card */
        .question-card {
            background: linear-gradient(145deg, #222 0%, #2a2a2a 100%);
            border-radius: 16px;
            padding: 2.5rem;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 2rem;
        }

        .question-card h3 {
            color: #ff6b35;
            margin-bottom: 2rem;
            font-size: 1.4rem;
            line-height: 1.5;
            text-align: center;
            font-weight: 600;
        }

        /* Options */
        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.8rem 1.5rem;
            background: linear-gradient(145deg, #333 0%, #3a3a3a 100%);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid #555;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            min-height: 70px;
            position: relative;
            overflow: hidden;
        }

        .option-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 107, 53, 0.1) 50%, 
                transparent 100%);
            transition: left 0.5s ease;
        }

        .option-label:hover::before {
            left: 100%;
        }

        .option-label:hover {
            border-color: #ff6b35;
            background: linear-gradient(145deg, #3a3a3a 0%, #444 100%);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.2);
        }

        .option-label.selected {
            border-color: #ff6b35;
            background: linear-gradient(145deg, #ff6b35 0%, #f7931e 100%);
            color: #000;
            font-weight: 600;
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(255, 107, 53, 0.4);
        }

        .option-label.selected::before {
            display: none;
        }

        .option-label span {
            color: #ccc;
            font-size: 1.05rem;
            transition: color 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .option-label:hover span {
            color: #fff;
        }

        .option-label.selected span {
            color: #000;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: #000;
            transform: translateY(-2px);
        }

        .assessment-buttons {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            margin-top: 3rem;
        }

        /* Results */
        .results-container {
            text-align: center;
        }

        .results-container h2 {
            color: #27ae60;
            margin-bottom: 2rem;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .score-item {
            background: linear-gradient(145deg, #333 0%, #3a3a3a 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #444;
            transition: transform 0.3s ease;
        }

        .score-item:hover {
            transform: translateY(-5px);
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .score-label {
            color: #ccc;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .overall-score-display {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: #000;
            padding: 2rem;
            border-radius: 16px;
            margin: 2rem 0;
            box-shadow: 0 15px 35px rgba(255, 107, 53, 0.3);
        }

        .overall-score-display .score-value {
            font-size: 3rem;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            body {
                padding-top: 70px;
            }

            .assessment-container {
                margin: 1rem;
                padding: 1.5rem;
            }

            .assessment-header h1 {
                font-size: 2.2rem;
            }

            .scores-grid {
                grid-template-columns: 1fr;
            }

            .assessment-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .btn {
                width: 100%;
            }

            .option-label {
                padding: 1.5rem 1rem;
                min-height: 60px;
            }

            .option-label span {
                font-size: 1rem;
            }
        }

        /* Loading state */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Success animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
    </style>

    <!-- FOUC Prevention -->
    <style>
        html { visibility: hidden; opacity: 0; }
        html.loaded { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="index.html">Vivify</a>
            </div>
        </nav>
    </header>

    <main>
        <div class="assessment-container">
            <div class="assessment-header">
                <div class="performance-badge">🚀 Performance Assessment</div>
                <h1>Unlock Your Peak Performance</h1>
                <p>Let's establish your current performance baseline across the key areas that drive student excellence</p>
                <p class="subtitle">Track your progress and build elite daily habits (5 minutes)</p>
            </div>

            <div class="progress-container">
                <div class="progress-text">
                    Question <span id="currentQuestion">1</span> of <span id="totalQuestions">20</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div id="questionsContainer" style="min-height: 350px;">
                <!-- Questions will be loaded here -->
            </div>

            <div class="assessment-buttons">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button class="btn btn-primary" id="completeBtn" onclick="completeAssessment()" style="display: none;">
                    Complete Assessment <i class="fas fa-trophy"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        const performanceQuestions = [
            // Physical Performance & Energy
            {
                category: 'physical',
                text: "How consistently do you maintain high energy levels throughout your day?",
                options: [
                    { text: "Always energetic and ready to perform", value: 95 },
                    { text: "Usually energetic with occasional dips", value: 80 },
                    { text: "Moderate energy, some afternoon crashes", value: 60 },
                    { text: "Often tired and low energy", value: 35 }
                ]
            },
            {
                category: 'physical',
                text: "How would you rate your physical fitness and strength?",
                options: [
                    { text: "Excellent fitness, very strong", value: 90 },
                    { text: "Good fitness level, regular exercise", value: 75 },
                    { text: "Average fitness, some physical activity", value: 55 },
                    { text: "Poor fitness, rarely exercise", value: 25 }
                ]
            },
            {
                category: 'physical',
                text: "How optimised is your sleep for peak performance?",
                options: [
                    { text: "Perfect sleep routine, wake up refreshed", value: 95 },
                    { text: "Good sleep most nights", value: 75 },
                    { text: "Inconsistent sleep, sometimes tired", value: 50 },
                    { text: "Poor sleep habits, often exhausted", value: 20 }
                ]
            },
            {
                category: 'physical',
                text: "How well do you recover from physical and mental challenges?",
                options: [
                    { text: "Bounce back quickly, excellent recovery", value: 90 },
                    { text: "Generally recover well", value: 70 },
                    { text: "Take some time to recover", value: 50 },
                    { text: "Struggle to recover, stay drained", value: 25 }
                ]
            },
            {
                category: 'physical',
                text: "How often do you push your physical limits and challenge yourself?",
                options: [
                    { text: "Regularly challenge myself physically", value: 85 },
                    { text: "Sometimes push my limits", value: 65 },
                    { text: "Occasionally challenge myself", value: 45 },
                    { text: "Rarely push beyond comfort zone", value: 25 }
                ]
            },

            // Mental Focus & Resilience
            {
                category: 'mental',
                text: "How well can you maintain laser focus during challenging tasks?",
                options: [
                    { text: "Exceptional focus, rarely distracted", value: 95 },
                    { text: "Good focus with minor distractions", value: 75 },
                    { text: "Moderate focus, get distracted sometimes", value: 55 },
                    { text: "Poor focus, easily distracted", value: 30 }
                ]
            },
            {
                category: 'mental',
                text: "How do you perform under pressure and tight deadlines?",
                options: [
                    { text: "Thrive under pressure, best performance", value: 90 },
                    { text: "Handle pressure well, stay composed", value: 75 },
                    { text: "Manage pressure okay, some stress", value: 55 },
                    { text: "Struggle under pressure, get overwhelmed", value: 25 }
                ]
            },
            {
                category: 'mental',
                text: "How quickly do you bounce back from setbacks or failures?",
                options: [
                    { text: "Bounce back immediately, learn fast", value: 95 },
                    { text: "Recover quickly, use failures as fuel", value: 80 },
                    { text: "Take some time but eventually recover", value: 60 },
                    { text: "Struggle to recover from setbacks", value: 30 }
                ]
            },
            {
                category: 'mental',
                text: "How confident are you in tackling new challenges?",
                options: [
                    { text: "Extremely confident, love challenges", value: 90 },
                    { text: "Generally confident in my abilities", value: 75 },
                    { text: "Somewhat confident, have some doubts", value: 55 },
                    { text: "Lack confidence, avoid challenges", value: 30 }
                ]
            },
            {
                category: 'mental',
                text: "How well do you manage stress and maintain emotional control?",
                options: [
                    { text: "Excellent stress management, always calm", value: 90 },
                    { text: "Good at managing stress", value: 70 },
                    { text: "Sometimes get stressed but cope", value: 50 },
                    { text: "Often overwhelmed by stress", value: 25 }
                ]
            },

            // Performance Nutrition
            {
                category: 'nutrition',
                text: "How strategically do you fuel your body for peak performance?",
                options: [
                    { text: "Highly strategic, optimised nutrition plan", value: 95 },
                    { text: "Generally eat well for performance", value: 75 },
                    { text: "Somewhat conscious of nutrition", value: 55 },
                    { text: "Poor eating habits, no strategy", value: 25 }
                ]
            },
            {
                category: 'nutrition',
                text: "How consistent are you with your eating schedule and habits?",
                options: [
                    { text: "Very consistent, perfect routine", value: 90 },
                    { text: "Mostly consistent eating habits", value: 70 },
                    { text: "Somewhat consistent, occasional lapses", value: 50 },
                    { text: "Inconsistent, erratic eating patterns", value: 25 }
                ]
            },
            {
                category: 'nutrition',
                text: "How well do you use nutrition to enhance your mental performance?",
                options: [
                    { text: "Actively use food to boost brain power", value: 85 },
                    { text: "Somewhat aware of food-brain connection", value: 65 },
                    { text: "Basic understanding, not optimised", value: 45 },
                    { text: "Never consider nutrition for mental performance", value: 20 }
                ]
            },
            {
                category: 'nutrition',
                text: "How disciplined are you with avoiding performance-draining foods?",
                options: [
                    { text: "Extremely disciplined, avoid all junk", value: 90 },
                    { text: "Generally disciplined with occasional treats", value: 70 },
                    { text: "Somewhat disciplined but give in to cravings", value: 50 },
                    { text: "Poor discipline, eat whatever I want", value: 25 }
                ]
            },

            // Excellence Habits & Life Mastery
            {
                category: 'lifeSkills',
                text: "How consistent are you with your daily performance routines?",
                options: [
                    { text: "Extremely consistent, never miss routines", value: 95 },
                    { text: "Very consistent, rarely skip", value: 80 },
                    { text: "Somewhat consistent, occasional skips", value: 60 },
                    { text: "Inconsistent, struggle with routines", value: 30 }
                ]
            },
            {
                category: 'lifeSkills',
                text: "How well do you manage your time and prioritise high-impact activities?",
                options: [
                    { text: "Master of time management, ultra productive", value: 95 },
                    { text: "Good time management skills", value: 75 },
                    { text: "Decent at managing time", value: 55 },
                    { text: "Poor time management, often scattered", value: 25 }
                ]
            },
            {
                category: 'lifeSkills',
                text: "How committed are you to continuous learning and self-improvement?",
                options: [
                    { text: "Obsessed with growth, constantly improving", value: 95 },
                    { text: "Very committed to learning", value: 80 },
                    { text: "Somewhat interested in improvement", value: 60 },
                    { text: "Rarely focus on self-improvement", value: 30 }
                ]
            },
            {
                category: 'lifeSkills',
                text: "How well do you track and measure your progress?",
                options: [
                    { text: "Meticulously track everything, data-driven", value: 90 },
                    { text: "Track important metrics regularly", value: 70 },
                    { text: "Occasionally track some things", value: 50 },
                    { text: "Rarely track progress", value: 25 }
                ]
            },
            {
                category: 'lifeSkills',
                text: "How disciplined are you with your financial habits and money management?",
                options: [
                    { text: "Excellent financial discipline, track everything", value: 85 },
                    { text: "Good money management habits", value: 70 },
                    { text: "Basic financial awareness", value: 50 },
                    { text: "Poor financial habits", value: 25 }
                ]
            },
            {
                category: 'lifeSkills',
                text: "How effectively do you eliminate distractions and time-wasters?",
                options: [
                    { text: "Ruthlessly eliminate all distractions", value: 90 },
                    { text: "Good at avoiding most distractions", value: 70 },
                    { text: "Sometimes get distracted", value: 50 },
                    { text: "Easily distracted, waste time often", value: 25 }
                ]
            }
        ];

        let currentQuestionIndex = 0;
        let responses = [];

        // Assessment State Manager
        class AssessmentStateManager {
            constructor() {
                this.answers = {};
                this.loadSavedAnswers();
            }

            saveAnswer(questionIndex, answerData) {
                this.answers[questionIndex] = answerData;
                localStorage.setItem('assessmentAnswers', JSON.stringify(this.answers));
            }

            getAnswer(questionIndex) {
                return this.answers[questionIndex] || null;
            }

            loadSavedAnswers() {
                const saved = localStorage.getItem('assessmentAnswers');
                if (saved) {
                    try {
                        this.answers = JSON.parse(saved);
                    } catch (error) {
                        console.error('Error loading saved answers:', error);
                        this.answers = {};
                    }
                }
            }

            clearAnswers() {
                this.answers = {};
                localStorage.removeItem('assessmentAnswers');
            }

            getAllAnswers() {
                return this.answers;
            }
        }

        // Initialize state manager
        const stateManager = new AssessmentStateManager();

        // Replace the redirect logic in your performance-baseline-assessment.html with this:
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('userLoggedIn') === 'true';
            
            if (!isLoggedIn) {
                window.location.href = 'login.html';
                return;
            }
            
            // AGGRESSIVE CHECK: If user has any performance data, redirect immediately
            const performanceData = localStorage.getItem('performanceData');
            console.log('Assessment page - checking performanceData:', performanceData ? 'EXISTS' : 'MISSING');
            
            if (performanceData) {
                console.log('Performance data found, redirecting to dashboard immediately');
                window.location.replace('dashboard.html');
                return;
            }
            
            console.log('No performance data found, starting assessment');
            
            // Continue with assessment setup only if no performance data exists
            document.getElementById('totalQuestions').textContent = performanceQuestions.length;
            
            const savedAnswers = stateManager.getAllAnswers();
            Object.entries(savedAnswers).forEach(([index, answerData]) => {
                responses[parseInt(index)] = answerData;
            });
            
            loadQuestion();
        });
        function loadQuestion() {
            const question = performanceQuestions[currentQuestionIndex];
            const container = document.getElementById('questionsContainer');
            
            container.innerHTML = `
                <div class="question-card fade-in-up">
                    <h3>${question.text}</h3>
                    <div class="options-grid">
                        ${question.options.map((option, index) => `
                            <div class="option-label" data-value="${option.value}">
                                <span>${option.text}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Add click handling for the option boxes
            const labels = container.querySelectorAll('.option-label');
            labels.forEach(label => {
                label.addEventListener('click', () => {
                    // Remove selected class from all options
                    labels.forEach(l => l.classList.remove('selected'));
                    // Add selected class to clicked option
                    label.classList.add('selected');
                    
                    // Save the answer immediately
                    const answerData = {
                        question: question.text,
                        category: question.category,
                        value: parseInt(label.dataset.value),
                        answer: label.textContent.trim()
                    };
                    
                    responses[currentQuestionIndex] = answerData;
                    stateManager.saveAnswer(currentQuestionIndex, answerData);
                });
            });

            // Restore previous selection if it exists
            const savedAnswer = stateManager.getAnswer(currentQuestionIndex);
            if (savedAnswer) {
                const targetOption = container.querySelector(`.option-label[data-value="${savedAnswer.value}"]`);
                if (targetOption) {
                    targetOption.classList.add('selected');
                }
            }

            updateProgress();
            updateButtons();
        }

        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / performanceQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const completeBtn = document.getElementById('completeBtn');

            prevBtn.style.display = currentQuestionIndex > 0 ? 'inline-block' : 'none';
            
            if (currentQuestionIndex === performanceQuestions.length - 1) {
                nextBtn.style.display = 'none';
                completeBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                completeBtn.style.display = 'none';
            }
        }

        function nextQuestion() {
            const selectedOption = document.querySelector('.option-label.selected');
            
            if (!selectedOption) {
                alert('Please select an answer before continuing.');
                return;
            }

            // Answer is already saved in the click handler
            if (currentQuestionIndex < performanceQuestions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        function completeAssessment() {
            const selectedOption = document.querySelector('.option-label.selected');
            
            if (!selectedOption) {
                alert('Please answer the final question.');
                return;
            }

            // Save final answer if not already saved
            if (!responses[currentQuestionIndex]) {
                const question = performanceQuestions[currentQuestionIndex];
                const answerData = {
                    question: question.text,
                    category: question.category,
                    value: parseInt(selectedOption.dataset.value),
                    answer: selectedOption.textContent.trim()
                };
                
                responses[currentQuestionIndex] = answerData;
                stateManager.saveAnswer(currentQuestionIndex, answerData);
            }

            calculatePerformanceScores();
        }

        // Replace the existing assessment completion code in your performance-baseline-assessment.html

        async function calculatePerformanceScores() {
            // Use saved answers from state manager to ensure we have all responses
            const allAnswers = stateManager.getAllAnswers();
            const completeResponses = [];
            
            // Build complete responses array from saved answers
            for (let i = 0; i < performanceQuestions.length; i++) {
                if (allAnswers[i]) {
                    completeResponses[i] = allAnswers[i];
                } else {
                    console.warn(`Missing answer for question ${i + 1}`);
                    completeResponses[i] = {
                        question: performanceQuestions[i].text,
                        category: performanceQuestions[i].category,
                        value: 60,
                        answer: 'Default response'
                    };
                }
            }

            const scores = {
                physical: [],
                mental: [],
                nutrition: [],
                lifeSkills: []
            };

            // Group responses by category
            completeResponses.forEach(response => {
                if (scores[response.category]) {
                    scores[response.category].push(response.value);
                }
            });

            // Calculate average for each category
            const finalScores = {};
            Object.keys(scores).forEach(category => {
                if (scores[category].length > 0) {
                    finalScores[category] = Math.round(
                        scores[category].reduce((sum, score) => sum + score, 0) / scores[category].length
                    );
                } else {
                    finalScores[category] = 60;
                }
            });

            finalScores.overall = Math.round(
                (finalScores.physical + finalScores.mental + finalScores.nutrition + finalScores.lifeSkills) / 4
            );

            console.log('Calculated performance scores:', finalScores);

            // FIXED: Save to backend using the correct structure and endpoint
            await savePerformanceDataToBackend(finalScores, completeResponses);

            // Always save locally as backup
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            
            const performanceData = {
                user: {
                    name: userProfile.username || userProfile.name || 'Student',
                    username: userProfile.username || userProfile.name || 'Student',
                    school: userProfile.school || 'Knox Grammar School',
                    yearLevel: userProfile.yearLevel || '',
                    userId: userProfile.id,
                    joinDate: new Date().toISOString(),
                    lastActive: new Date().toISOString()
                },
                scores: finalScores,
                activities: [{
                    id: Date.now(),
                    type: 'baseline_assessment',
                    category: 'general',
                    description: 'Completed performance baseline assessment',
                    points: 50,
                    timestamp: new Date().toISOString()
                }],
                customGoals: [],
                achievements: {
                    first_login: true,
                    assessment_complete: true
                },
                baselineCompleted: true,
                assessmentResponses: completeResponses,
                lastUpdated: new Date().toISOString(),
                totalXP: 50,
                streaks: {
                    currentStreak: 1,
                    longestStreak: 1,
                    lastActiveDate: new Date().toDateString()
                }
            };

            localStorage.setItem('performanceData', JSON.stringify(performanceData));
            localStorage.removeItem('needsBaselineAssessment');
            stateManager.clearAnswers();
            
            console.log('Performance data saved locally:', performanceData);
            showResults(finalScores);
        }

        // NEW: Backend integration function that matches your backend route structure
        async function savePerformanceDataToBackend(scores, responses) {
            const API_BASE_URL = 'http://localhost:3001/api';
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                console.log('No auth token, skipping backend save');
                return;
            }

            // Transform the data to match your backend User model structure
            const backendData = {
                physicalFitness: {
                    currentLevel: scores.physical >= 75 ? 'advanced' : scores.physical >= 55 ? 'intermediate' : 'beginner',
                    goals: ['improve_performance'],
                    exerciseFrequency: scores.physical >= 75 ? 'regularly' : scores.physical >= 55 ? 'sometimes' : 'rarely'
                },
                academicPerformance: {
                    currentGPA: scores.overall >= 85 ? 'A' : scores.overall >= 70 ? 'B+' : scores.overall >= 55 ? 'B' : 'C+',
                    studyHours: Math.floor(scores.mental / 10),
                    challenges: ['time_management', 'focus']
                },
                mentalWellbeing: {
                    stressLevel: Math.max(1, Math.min(10, Math.floor((100 - scores.mental) / 10))),
                    sleepHours: scores.physical >= 70 ? 8 : 7,
                    mindfulnessInterest: scores.mental >= 70
                },
                socialSkills: {
                    confidenceLevel: Math.floor(scores.overall / 10),
                    socialGoals: ['leadership', 'communication']
                },
                // ADD THIS: Include the actual calculated scores
                calculatedScores: {
                    physical: scores.physical,
                    mental: scores.mental,
                    nutrition: scores.nutrition,
                    lifeSkills: scores.lifeSkills,
                    overall: scores.overall
                }
            };

            try {
                console.log('Sending performance data to backend:', backendData);
                
                const response = await fetch(`${API_BASE_URL}/auth/performance-baseline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(backendData)
                });

                const result = await response.json();
                console.log('Backend response:', result);

                if (result.success) {
                    console.log('✅ Performance data saved to backend successfully');
                    // Update local storage with backend response if it has additional data
                    if (result.user && result.user.performanceData) {
                        const existingData = JSON.parse(localStorage.getItem('performanceData') || '{}');
                        existingData.backendSynced = true;
                        existingData.serverData = result.user.performanceData;
                        localStorage.setItem('performanceData', JSON.stringify(existingData));
                    }
                } else {
                    console.error('❌ Backend save failed:', result.error);
                }

            } catch (error) {
                console.error('❌ Network error saving to backend:', error);
                // Don't throw - we'll continue with local storage only
            }
        }

        function showResults(scores) {
            const container = document.getElementById('questionsContainer');
            
            const getScoreColor = (score) => {
                if (score >= 85) return '#27ae60';
                if (score >= 70) return '#ff6b35';
                if (score >= 55) return '#f39c12';
                return '#e67e22';
            };

            const getPerformanceLevel = (score) => {
                if (score >= 85) return 'Elite Performer';
                if (score >= 70) return 'High Performer';
                if (score >= 55) return 'Developing Performer';
                return 'Emerging Performer';
            };

            const getScoreMessage = (overall) => {
                if (overall >= 85) return "Exceptional! You're already operating at an elite performance level with outstanding habits across all areas.";
                if (overall >= 70) return "Strong foundation! You're a high performer with solid habits - ready to push to the next level.";
                if (overall >= 55) return "Good potential! You have developing performance habits with clear opportunities for significant growth.";
                return "Perfect starting point! You're ready to transform your daily habits and unlock your performance potential.";
            };

            container.innerHTML = `
                <div class="results-container fade-in-up">
                    <h2><i class="fas fa-trophy"></i> Performance Assessment Complete!</h2>
                    
                    <div style="background: linear-gradient(145deg, #222 0%, #2a2a2a 100%); border-radius: 16px; padding: 2.5rem; margin-bottom: 2rem; border: 1px solid #333;">
                        <h3 style="color: #ff6b35; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Your Performance Baseline Scores</h3>
                        
                        <div class="scores-grid">
                            <div class="score-item">
                                <div class="score-value" style="color: ${getScoreColor(scores.physical)};">${scores.physical}%</div>
                                <div class="score-label">Physical Performance</div>
                            </div>
                            <div class="score-item">
                                <div class="score-value" style="color: ${getScoreColor(scores.mental)};">${scores.mental}%</div>
                                <div class="score-label">Mental Focus</div>
                            </div>
                            <div class="score-item">
                                <div class="score-value" style="color: ${getScoreColor(scores.nutrition)};">${scores.nutrition}%</div>
                                <div class="score-label">Performance Nutrition</div>
                            </div>
                            <div class="score-item">
                                <div class="score-value" style="color: ${getScoreColor(scores.lifeSkills)};">${scores.lifeSkills}%</div>
                                <div class="score-label">Excellence Habits</div>
                            </div>
                        </div>
                        
                        <div class="overall-score-display">
                            <div style="font-size: 3rem; font-weight: bold; margin-bottom: 0.5rem;">${scores.overall}%</div>
                            <div style="font-weight: 600; font-size: 1.2rem;">Overall Performance Score</div>
                            <div style="font-size: 1rem; margin-top: 0.5rem; opacity: 0.9;">${getPerformanceLevel(scores.overall)}</div>
                        </div>
                        
                        <div style="background: #2a2a2a; border-radius: 12px; padding: 2rem; margin-top: 2rem; border: 1px solid #333;">
                            <h4 style="color: #ff6b35; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-line"></i> Your Performance Profile
                            </h4>
                            <p style="color: #ccc; margin-bottom: 1rem; line-height: 1.6;">${getScoreMessage(scores.overall)}</p>
                            <div style="background: #333; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ff6b35;">
                                <p style="color: #ccc; margin: 0; font-size: 0.95rem; line-height: 1.6;">
                                    <i class="fas fa-rocket" style="color: #ff6b35; margin-right: 0.5rem;"></i>
                                    <strong>Ready to level up?</strong> These baseline scores show your current performance level. 
                                    Use Vivify's daily challenges, habit tracking, and community features to systematically 
                                    improve each area and unlock your peak performance potential!
                                </p>
                            </div>
                        </div>

                        <div style="margin-top: 2.5rem;">
                            <h4 style="color: #ff6b35; margin-bottom: 1.5rem; text-align: center; font-size: 1.3rem;">
                                <i class="fas fa-target"></i> Your Performance Training Starts Now
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                                <div style="background: linear-gradient(145deg, #333 0%, #3a3a3a 100%); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #444; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-dumbbell" style="font-size: 2rem; color: #e74c3c; margin-bottom: 1rem; display: block;"></i>
                                    <h5 style="margin: 0.5rem 0; color: #fff; font-size: 1.1rem;">Physical Edge Training</h5>
                                    <p style="color: #ccc; font-size: 0.9rem; margin: 0; line-height: 1.4;">Build energy, strength and athletic performance</p>
                                </div>
                                <div style="background: linear-gradient(145deg, #333 0%, #3a3a3a 100%); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #444; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-brain" style="font-size: 2rem; color: #3498db; margin-bottom: 1rem; display: block;"></i>
                                    <h5 style="margin: 0.5rem 0; color: #fff; font-size: 1.1rem;">Mental Toughness</h5>
                                    <p style="color: #ccc; font-size: 0.9rem; margin: 0; line-height: 1.4;">Develop focus, resilience and pressure performance</p>
                                </div>
                                <div style="background: linear-gradient(145deg, #333 0%, #3a3a3a 100%); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #444; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-apple-alt" style="font-size: 2rem; color: #27ae60; margin-bottom: 1rem; display: block;"></i>
                                    <h5 style="margin: 0.5rem 0; color: #fff; font-size: 1.1rem;">Fuel Optimization</h5>
                                    <p style="color: #ccc; font-size: 0.9rem; margin: 0; line-height: 1.4;">Strategic nutrition for peak brain and body function</p>
                                </div>
                                <div style="background: linear-gradient(145deg, #333 0%, #3a3a3a 100%); padding: 1.5rem; border-radius: 12px; text-align: center; border: 1px solid #444; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <i class="fas fa-chart-line" style="font-size: 2rem; color: #ff6b35; margin-bottom: 1rem; display: block;"></i>
                                    <h5 style="margin: 0.5rem 0; color: #fff; font-size: 1.1rem;">Elite Habits</h5>
                                    <p style="color: #ccc; font-size: 0.9rem; margin: 0; line-height: 1.4;">Daily systems and habits of high performers</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Update buttons
            document.querySelector('.assessment-buttons').innerHTML = `
                <button class="btn btn-primary" onclick="goToDashboard()" style="padding: 1rem 3rem; font-size: 1.2rem;">
                    <i class="fas fa-rocket"></i> Start Performance Training
                </button>
            `;
        }

        function goToDashboard() {
            // Debug: Check what we have before redirect
            console.log('=== DASHBOARD REDIRECT DEBUG ===');
            console.log('performanceData in localStorage:', localStorage.getItem('performanceData'));
            console.log('needsBaselineAssessment:', localStorage.getItem('needsBaselineAssessment'));
            
            // Verify we have all required data
            const performanceData = localStorage.getItem('performanceData');
            const userProfile = localStorage.getItem('userProfile');
            const username = localStorage.getItem('username');
            
            console.log('Pre-dashboard check:', {
                hasPerformanceData: !!performanceData,
                hasUserProfile: !!userProfile,
                username: username
            });
            
            if (!performanceData) {
                console.error('PROBLEM: Performance data is missing!');
                alert('Assessment data not saved properly. Please try again.');
                return;
            }
            
            if (!username) {
                alert('User data missing. Please log in again.');
                window.location.href = 'login.html';
                return;
            }
            
            // Show loading message
            const btn = document.querySelector('.assessment-buttons button');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Launching your performance dashboard...';
                btn.disabled = true;
                btn.classList.add('loading');
            }
            
            // Small delay to show loading state
            setTimeout(() => {
                console.log('Redirecting to dashboard with performance data');
                window.location.href = 'dashboard.html';
            }, 2000);
        }

        // Allow Enter key to advance questions
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (currentQuestionIndex === performanceQuestions.length - 1) {
                    const completeBtn = document.getElementById('completeBtn');
                    if (completeBtn.style.display !== 'none') {
                        completeAssessment();
                    }
                } else {
                    const nextBtn = document.getElementById('nextBtn');
                    if (nextBtn.style.display !== 'none') {
                        nextQuestion();
                    }
                }
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                previousQuestion();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                if (document.querySelector('.option-label.selected')) {
                    nextQuestion();
                }
            }
        });
        // Add this to your performance-baseline-assessment.html file
        async function savePerformanceData(performanceData) {
            const API_BASE_URL = 'http://localhost:3001/api';
            const authToken = localStorage.getItem('authToken');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/performance-baseline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(performanceData)
                });

                const data = await response.json();

                if (data.success) {
                    console.log('Performance data saved successfully');
                    
                    // Store locally for offline access
                    localStorage.setItem('performanceData', JSON.stringify(data.user.performanceData));
                    localStorage.removeItem('needsBaselineAssessment');
                    
                    // Redirect to dashboard
                    window.location.href = 'dashboard.html';
                    
                } else {
                    console.error('Failed to save performance data:', data.error);
                    alert('Performance data saved locally but failed to sync with server.');
                    localStorage.setItem('performanceData', JSON.stringify(performanceData));
                    window.location.href = 'dashboard.html';
                }

            } catch (error) {
                console.error('Network error saving performance data:', error);
                // Save locally as fallback
                localStorage.setItem('performanceData', JSON.stringify(performanceData));
                window.location.href = 'dashboard.html';
            }
        }
    </script>
</body>
</html>