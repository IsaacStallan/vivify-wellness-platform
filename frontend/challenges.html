<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Performance Challenges - Vivify</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#0a0a0a;color:#fff;line-height:1.6;overflow-x:hidden}
    header{position:fixed;top:0;width:100%;background:rgba(10,10,10,.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.1);z-index:1000;transition:all .3s ease}
    nav{max-width:1400px;margin:0 auto;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center}
    .left-nav{display:flex;align-items:center;gap:3rem}
    .logo a{font-size:1.8rem;font-weight:900;background:linear-gradient(135deg,#f39c12,#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-decoration:none}
    .left-nav ul,.right-nav ul{display:flex;list-style:none;gap:2rem;align-items:center}
    .left-nav a,.right-nav a{color:#fff;text-decoration:none;font-weight:500;transition:all .3s ease;position:relative}
    .left-nav a:hover,.right-nav a:hover{color:#f39c12}
    .left-nav a::after{content:'';position:absolute;bottom:-5px;left:0;width:0;height:2px;background:linear-gradient(135deg,#f39c12,#e67e22);transition:width .3s ease}
    .left-nav a:hover::after,.left-nav a.active::after{width:100%}
    .hidden{display:none!important}

    .challenges-container{max-width:1400px;margin:0 auto;padding:120px 2rem 2rem}

    .challenges-hero{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:3rem 2rem;margin-bottom:3rem;text-align:center;position:relative;overflow:hidden}
    .challenges-hero::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(135deg,#f39c12,#e67e22)}
    .challenges-hero h1{font-size:3rem;font-weight:800;background:linear-gradient(135deg,#fff,#f39c12);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:1rem}
    .challenges-hero p{color:rgba(255,255,255,.7);font-size:1.2rem;max-width:700px;margin:0 auto 2rem;line-height:1.6}
    .hero-stats{display:flex;justify-content:center;gap:4rem;margin-top:2rem}
    .hero-stat{text-align:center}
    .hero-stat-value{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,#f39c12,#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:block;margin-bottom:.5rem}
    .hero-stat-label{color:rgba(255,255,255,.7);font-size:.9rem;font-weight:500;text-transform:uppercase;letter-spacing:.5px}

    .filter-tabs{display:flex;gap:1rem;margin-bottom:3rem;flex-wrap:wrap;overflow-x:auto;padding-bottom:.5rem}
    .filter-tab{background:transparent;border:2px solid rgba(255,255,255,.1);color:rgba(255,255,255,.7);padding:.75rem 1.5rem;border-radius:50px;cursor:pointer;transition:all .3s ease;font-weight:500;white-space:nowrap;font-family:inherit}
    .filter-tab:hover,.filter-tab.active{border-color:#f39c12;color:#f39c12;background:rgba(243,156,18,.1)}

    .challenge-sections{display:flex;flex-direction:column;gap:3rem}
    .challenge-section{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:3rem 2rem;position:relative;overflow:hidden}
    .challenge-section::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(135deg,#f39c12,#e67e22);transform:scaleX(0);transition:transform .4s ease}
    .challenge-section:hover::before{transform:scaleX(1)}
    .section-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem}
    .section-title{font-size:2rem;font-weight:700;background:linear-gradient(135deg,#fff,#f39c12);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:flex;align-items:center;gap:.75rem}
    .section-description{color:rgba(255,255,255,.7);font-size:1rem;margin-top:.5rem;line-height:1.5}

    .challenges-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:2rem}
    .challenge-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:2rem;transition:all .4s ease;position:relative;overflow:hidden}
    .challenge-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(135deg,#f39c12,#e67e22);transform:scaleX(0);transition:transform .4s ease}
    .challenge-card:hover::before{transform:scaleX(1)}
    .challenge-card:hover{transform:translateY(-10px);background:rgba(243,156,18,.05);border-color:rgba(243,156,18,.2)}
    .challenge-card.featured{border-color:#f39c12;background:rgba(243,156,18,.05)}
    .challenge-card.featured::before{transform:scaleX(1)}
    .challenge-card.featured::after{content:'FEATURED';position:absolute;top:1.5rem;right:1.5rem;background:linear-gradient(135deg,#f39c12,#e67e22);color:#000;padding:.35rem .85rem;border-radius:50px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
    .challenge-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem}
    .challenge-info h3{color:#fff;font-size:1.3rem;font-weight:700;margin-bottom:.75rem}
    .challenge-difficulty{display:flex;align-items:center;gap:.75rem;color:rgba(255,255,255,.7);font-size:.85rem;font-weight:500}
    .difficulty-dots{display:flex;gap:3px}
    .difficulty-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2)}
    .difficulty-dot.active{background:#f39c12}
    .challenge-badge{background:rgba(255,255,255,.1);color:rgba(255,255,255,.8);padding:.35rem .85rem;border-radius:50px;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .challenge-badge.weekly{background:rgba(52,152,219,.2);color:#3498db}
    .challenge-badge.monthly{background:rgba(155,89,182,.2);color:#9b59b6}
    .challenge-badge.ongoing{background:rgba(39,174,96,.2);color:#27ae60}
    .challenge-description{color:rgba(255,255,255,.8);margin-bottom:1.5rem;line-height:1.5;font-size:.95rem}
    .challenge-stats{display:flex;justify-content:space-between;margin-bottom:1.5rem;padding:1.25rem;background:rgba(255,255,255,.03);border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    .challenge-stat{text-align:center}
    .challenge-stat-value{font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,#f39c12,#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;display:block;margin-bottom:.25rem}
    .challenge-stat-label{font-size:.75rem;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.5px;font-weight:500}
    .challenge-progress{margin-bottom:2rem}
    .progress-header{display:flex;justify-content:space-between;margin-bottom:.75rem}
    .progress-text{color:rgba(255,255,255,.7);font-size:.9rem;font-weight:500}
    .progress-percentage{color:#f39c12;font-weight:700;font-size:.9rem}
    .progress-bar{background:rgba(255,255,255,.1);height:8px;border-radius:4px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#f39c12,#e67e22);transition:width .3s ease;border-radius:4px}
    .challenge-actions{display:flex;gap:1rem;align-items:center}
    .btn{padding:.75rem 1.5rem;border-radius:50px;font-weight:600;cursor:pointer;transition:all .3s ease;border:none;font-size:.9rem;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;font-family:inherit}
    .btn-primary{background:linear-gradient(135deg,#f39c12,#e67e22);color:#000;flex:1}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 15px 35px rgba(243,156,18,.4)}
    .btn-secondary{background:transparent;color:#f39c12;border:2px solid rgba(243,156,18,.2);padding:.5rem;width:45px;height:45px;border-radius:50%}
    .btn-secondary:hover{background:rgba(243,156,18,.1);border-color:rgba(243,156,18,.4)}
    .progress-btn{background:#3498db;color:#fff;padding:.5rem 1rem;border-radius:25px;border:none;cursor:pointer;font-size:.8rem;font-weight:600;transition:all .3s ease}
    .progress-btn:hover{background:#2980b9;transform:translateY(-1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
    .btn.completed{background:#27ae60!important;color:#fff!important}
    .btn.in-progress{background:#3498db!important;color:#fff!important}

    .leaderboard{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:3rem 2rem;margin-top:3rem;position:relative;overflow:hidden}
    .leaderboard::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(135deg,#f39c12,#e67e22)}
    .leaderboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem}
    .leaderboard-list{display:flex;flex-direction:column;gap:1rem}
    .leaderboard-item{display:flex;align-items:center;padding:1.25rem;background:rgba(255,255,255,.03);border-radius:12px;transition:all .3s ease;border:1px solid rgba(255,255,255,.1)}
    .leaderboard-item:hover{background:rgba(243,156,18,.1);border-color:rgba(243,156,18,.2);transform:translateY(-2px)}
    .leaderboard-item.current-user{border-color:#f39c12;background:rgba(243,156,18,.1)}
    .leaderboard-rank{font-size:1.3rem;font-weight:800;background:linear-gradient(135deg,#f39c12,#e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;min-width:50px}
    .leaderboard-avatar{width:50px;height:50px;border-radius:50%;background:rgba(243,156,18,.1);display:flex;align-items:center;justify-content:center;margin:0 1rem;color:#f39c12;font-size:1.2rem}
    .leaderboard-info{flex:1}
    .leaderboard-name{color:#fff;font-weight:600;margin-bottom:.25rem;font-size:1rem}
    .leaderboard-school{color:rgba(255,255,255,.7);font-size:.85rem}
    .leaderboard-score{color:#f39c12;font-weight:700;font-size:1.1rem}
    .overall-score{display:flex;flex-direction:column;align-items:flex-end;gap:.25rem}
    .level-badge{background:linear-gradient(135deg,#f39c12,#e67e22);color:#000;padding:.2rem .5rem;border-radius:12px;font-size:.7rem;font-weight:700;text-transform:uppercase}

    .mini-leaderboard {
      margin: 1rem 0;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 1rem;
    }

    .mini-leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .mini-leaderboard-item:last-child {
      border-bottom: none;
    }

    .mini-leaderboard-item.current-user {
      background: rgba(243,156,18,0.1);
      border-radius: 4px;
      padding: 0.5rem;
      color: #f39c12;
      font-weight: 600;
    }

    .mini-leaderboard-item .rank {
      color: #f39c12;
      font-weight: 600;
      min-width: 30px;
    }

    .mini-leaderboard-item .name {
      flex: 1;
      margin: 0 1rem;
    }

    .mini-leaderboard-item .progress {
      color: #27ae60;
      font-weight: 600;
    }

    .achievements-section {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 24px;
      padding: 2rem;
      position: relative;
      overflow: hidden;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .achievement-card {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all .3s ease;
    }

    .achievement-card.unlocked {
      border-color: #f39c12;
      background: rgba(243,156,18,.1);
    }

    .achievement-card.locked {
      opacity: 0.5;
      filter: grayscale(100%);
    }

    .achievement-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .achievement-name {
      color: #fff;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .achievement-description {
      color: rgba(255,255,255,.7);
      font-size: 0.85rem;
    }

    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .fade-in-up{animation:fadeInUp .6s ease-out}
    .notification{position:fixed;top:100px;right:20px;background:#27ae60;color:#fff;padding:1rem 1.5rem;border-radius:50px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:1000;opacity:0;transform:translateY(-20px);transition:all .3s ease;max-width:350px;font-weight:600}
    .notification.info{background:#3498db}
    .notification.error{background:#e74c3c}
    .notification.show{opacity:1;transform:translateY(0)}

    @media (max-width:768px){
      .left-nav ul,.right-nav ul{display:none}
      .challenges-container{padding:100px 1rem 2rem}
      .challenges-hero{padding:2rem 1rem}
      .challenges-hero h1{font-size:2rem}
      .hero-stats{flex-direction:column;gap:1.5rem}
      .challenges-grid{grid-template-columns:1fr}
      .challenge-stats{flex-direction:column;gap:1rem}
      .challenge-actions{flex-direction:column}
      .section-title{font-size:1.5rem}
    }
  @media (max-width: 768px) {
            /* FORCE hide all desktop navigation */
            nav ul,
            nav li,
            .left-nav ul,
            .right-nav ul,
            .left-nav li,
            .right-nav li,
            .left-nav > ul,
            .right-nav > ul {
                display: none !important;
                visibility: hidden !important;
            }
            
            /* Ensure nav container works properly */
            nav {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 1rem !important;
                flex-wrap: nowrap !important;
            }
            
            /* Keep logo visible */
            .logo,
            .logo a {
                display: block !important;
                visibility: visible !important;
                font-size: 1.5rem !important;
                white-space: nowrap !important;
            }
            
            /* Force show mobile button if it exists */
            .mobile-menu-btn {
                display: flex !important;
                visibility: visible !important;
                flex-direction: column;
                background: none;
                border: none;
                cursor: pointer;
                padding: 0.5rem;
                z-index: 1001;
            }
            
            /* Mobile button styles */
            .mobile-menu-btn .hamburger {
                width: 25px;
                height: 3px;
                background: #ffffff;
                margin: 3px 0;
                transition: 0.3s;
                border-radius: 2px;
            }
            
            /* Ensure right-nav container shows mobile button */
            .right-nav {
                display: flex !important;
                align-items: center !important;
                visibility: visible !important;
            }
        }

        /* If no mobile button exists, add this emergency button */
        @media (max-width: 768px) {
            nav:not(:has(.mobile-menu-btn))::after {
                content: "☰";
                position: absolute;
                right: 1rem;
                top: 50%;
                transform: translateY(-50%);
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
            }
        }
        .mobile-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .mobile-menu.active {
            opacity: 1;
            visibility: visible;
        }

        .mobile-menu-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 2rem;
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 2rem;
        }

        .mobile-menu-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 2rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .mobile-menu-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-link {
            color: #ffffff;
            text-decoration: none;
            font-size: 1.2rem;
            font-weight: 500;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .mobile-menu-link:hover {
            color: #f39c12;
            padding-left: 1rem;
        }

        .mobile-menu-link.mobile-cta {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: #000 !important;
            border-radius: 12px;
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
            border: none;
        }

        .mobile-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 1rem 0;
        }

        .mobile-menu-btn.active .hamburger:nth-child(1) {
            transform: rotate(-45deg) translate(-5px, 6px);
        }

        .mobile-menu-btn.active .hamburger:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active .hamburger:nth-child(3) {
            transform: rotate(45deg) translate(-5px, -6px);
        }

        /* Add this to your CSS to ensure mobile elements are hidden on desktop */
        @media (min-width: 769px) {
            .mobile-menu,
            .mobile-menu-btn {
                display: none !important;
                visibility: hidden !important;
            }
        }
    </style>
    <script>
        // Authentication-aware mobile menu
function createMobileMenu() {
    // Only create mobile menu on mobile devices
    if (window.innerWidth > 768) {
        return; // Exit early on desktop
    }
    
    // Check authentication status
    const authToken = localStorage.getItem('authToken');
    const userLoggedIn = localStorage.getItem('userLoggedIn');
    const isLoggedIn = !!(authToken || userLoggedIn === 'true');
    const username = localStorage.getItem('username') || 'User';
    
    console.log('Auth check:', { authToken, userLoggedIn, isLoggedIn, username }); // Debug log
    
    // Create mobile menu if it doesn't exist
    if (!document.getElementById('mobile-menu')) {
        const header = document.querySelector('header');
        const mobileMenu = document.createElement('div');
        mobileMenu.id = 'mobile-menu';
        mobileMenu.className = 'mobile-menu';
        
        // Generate auth-specific menu items
        let authMenuItems = '';
        if (isLoggedIn) {
            authMenuItems = `
                <div class="mobile-menu-divider"></div>
                <div class="mobile-user-info">
                    <span style="color: #f39c12; font-weight: 600; padding: 0.5rem 0;">Welcome, ${username}!</span>
                </div>
                <a href="dashboard.html" class="mobile-menu-link mobile-cta">Dashboard</a>
                <a href="profile.html" class="mobile-menu-link">Profile</a>
                <a href="#" class="mobile-menu-link" onclick="handleMobileLogout(event)">Logout</a>
            `;
        } else {
            authMenuItems = `
                <div class="mobile-menu-divider"></div>
                <a href="login.html" class="mobile-menu-link">Login</a>
                <a href="signup.html" class="mobile-menu-link mobile-cta">Start Training</a>
            `;
        }
        
        mobileMenu.innerHTML = `
            <div class="mobile-menu-content">
                <div class="mobile-menu-header">
                    <div class="logo"><a href="index.html">Vivify</a></div>
                    <button class="mobile-menu-close" onclick="closeMobileMenu()">×</button>
                </div>
                <div class="mobile-menu-links">
                    <a href="index.html" class="mobile-menu-link">Home</a>
                    <a href="index.html#training" class="mobile-menu-link">Training Areas</a>
                    <a href="index.html#habits" class="mobile-menu-link">Habits & Challenges</a>
                    <a href="about.html" class="mobile-menu-link">About</a>
                    <a href="community.html" class="mobile-menu-link">Community</a>
                    ${authMenuItems}
                </div>
            </div>
        `;
        header.appendChild(mobileMenu);
    }
    
    // Create mobile button if it doesn't exist
    if (!document.getElementById('mobile-menu-btn')) {
        const nav = document.querySelector('nav');
        const rightNav = nav.querySelector('.right-nav') || nav;
        const mobileBtn = document.createElement('button');
        mobileBtn.id = 'mobile-menu-btn';
        mobileBtn.className = 'mobile-menu-btn';
        mobileBtn.onclick = toggleMobileMenu;
        mobileBtn.innerHTML = `
            <span class="hamburger"></span>
            <span class="hamburger"></span>
            <span class="hamburger"></span>
        `;
        rightNav.appendChild(mobileBtn);
    }
}

function handleMobileLogout(event) {
    event.preventDefault();
    if (confirm('Are you sure you want to logout?')) {
        // Clear all auth data
        localStorage.clear();
        
        // Close mobile menu
        closeMobileMenu();
        
        // Refresh the page to update UI
        window.location.reload();
    }
}

function toggleMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    const btn = document.getElementById('mobile-menu-btn');
    
    menu.classList.toggle('active');
    btn.classList.toggle('active');
    
    if (menu.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
    } else {
        document.body.style.overflow = '';
    }
}

function closeMobileMenu() {
    const menu = document.getElementById('mobile-menu');
    const btn = document.getElementById('mobile-menu-btn');
    
    menu.classList.remove('active');
    btn.classList.remove('active');
    document.body.style.overflow = '';
}

// Function to update mobile menu when auth state changes
function updateMobileMenuAuth() {
    const existingMenu = document.getElementById('mobile-menu');
    if (existingMenu) {
        existingMenu.remove();
    }
    createMobileMenu();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', createMobileMenu);

// Listen for auth state changes (if you have an auth system that fires events)
window.addEventListener('authStateChanged', updateMobileMenuAuth);

// Export functions for external use
window.updateMobileMenuAuth = updateMobileMenuAuth;
window.handleMobileLogout = handleMobileLogout;
// Add this at the end of your mobile menu script
window.addEventListener('resize', function() {
    if (window.innerWidth > 768) {
        // Remove mobile elements on desktop
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileBtn = document.getElementById('mobile-menu-btn');
        
        if (mobileMenu) mobileMenu.remove();
        if (mobileBtn) mobileBtn.remove();
        
        // Reset body overflow
        document.body.style.overflow = '';
    } else if (window.innerWidth <= 768) {
        // Recreate mobile menu if switching to mobile
        const existingMenu = document.getElementById('mobile-menu');
        if (!existingMenu) {
            createMobileMenu();
        }
    }
});
        </script>
</head>
<body>
<header>
  <nav>
    <div class="left-nav">
      <div class="logo"><a href="index.html">Vivify</a></div>
      <ul>
        <li><a href="habits-tracker.html">Daily Habits</a></li>
        <li><a href="challenges.html" class="active">Challenges</a></li>
        <li><a href="community.html">Community</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </div>
    <div class="right-nav">
      <ul>
        <li><a href="login.html" id="login-link" class="hidden">Login</a></li>
        <li><a href="signup.html" id="signup-link" class="cta-nav hidden">Start Training</a></li>
        <li><a href="dashboard.html" id="dashboard-link">Dashboard</a></li>
        <li><a href="profile.html" id="profile-link">Profile</a></li>
        <li><a href="#" id="logout-link">Logout</a></li>
      </ul>
    </div>
  </nav>
</header>

<main class="challenges-container">
  <!-- Hero -->
  <div class="challenges-hero fade-in-up">
    <h1>Performance Challenges</h1>
    <p>Push your limits, compete with peers, and unlock your peak potential through structured challenges designed for ambitious students</p>
    <div class="hero-stats">
      <div class="hero-stat">
        <span class="hero-stat-value" id="activeChallenges">0</span>
        <span class="hero-stat-label">Active Challenges</span>
      </div>
      <div class="hero-stat">
        <span class="hero-stat-value" id="completedChallenges">0</span>
        <span class="hero-stat-label">Completed</span>
      </div>
      <div class="hero-stat">
        <span class="hero-stat-value" id="totalPoints">0</span>
        <span class="hero-stat-label">Total Points</span>
      </div>
    </div>
  </div>
  <div class="achievements-section fade-in-up" style="margin-bottom: 2rem;">
    <h2 class="section-title"><i class="fas fa-trophy"></i>Your Achievements</h2>
    <div class="achievements-grid" id="achievementsGrid">
      <!-- Achievements will be populated by JavaScript -->
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-tabs">
    <button class="filter-tab active" data-filter="all">All Challenges</button>
    <button class="filter-tab" data-filter="featured">Featured</button>
    <button class="filter-tab" data-filter="weekly">Weekly</button>
    <button class="filter-tab" data-filter="monthly">Monthly</button>
    <button class="filter-tab" data-filter="ongoing">Ongoing</button>
  </div>

  <!-- Sections -->
  <div class="challenge-sections">

    <!-- Physical -->
    <div class="challenge-section fade-in-up">
      <div class="section-header">
        <div>
          <h2 class="section-title"><i class="fas fa-dumbbell"></i>Physical Performance</h2>
          <p class="section-description">Build strength, endurance, and energy optimization for peak physical performance</p>
        </div>
      </div>

      <div class="challenges-grid">
        <!-- Fitness Foundation -->
        <div class="challenge-card featured" data-challenge="fitness-foundation">
          <div class="challenge-header">
            <div class="challenge-info">
              <h3>30-Day Fitness Foundation</h3>
              <div class="challenge-difficulty">
                <span>Beginner</span>
                <div class="difficulty-dots">
                  <div class="difficulty-dot active"></div><div class="difficulty-dot"></div><div class="difficulty-dot"></div>
                </div>
              </div>
            </div>
            <div class="challenge-badge monthly">Monthly</div>
          </div>

          <p class="challenge-description">
            Build a solid fitness foundation with 30 minutes of daily physical activity. Track workouts, measure progress, and develop the exercise habit that elite performers maintain.
          </p>

          <div class="challenge-stats">
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="fitness-foundation-participants">0</span>
              <span class="challenge-stat-label">Participants</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="fitness-foundation-days">23</span>
              <span class="challenge-stat-label">Days Left</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">500</span>
              <span class="challenge-stat-label">Points</span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-header">
              <span class="progress-text">Your Progress</span>
              <span class="progress-percentage" id="fitness-foundation-progress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="fitness-foundation-fill" style="width:0%"></div>
            </div>
          </div>

          <div class="challenge-actions">
            <button class="btn btn-primary" id="fitness-foundation-btn" onclick="joinChallenge('fitness-foundation')">Join Challenge</button>
            <button class="progress-btn" id="fitness-foundation-progress-btn" onclick="logProgress('fitness-foundation')" style="display:none;">Log Progress</button>
            <button class="btn btn-secondary" onclick="viewChallenge('fitness-foundation')" title="View Details"><i class="fas fa-info"></i></button>
          </div>
        </div>

        <!-- Morning Energy -->
        <div class="challenge-card" data-challenge="morning-energy">
          <div class="challenge-header">
            <div class="challenge-info">
              <h3>Morning Energy Boost</h3>
              <div class="challenge-difficulty">
                <span>Beginner</span>
                <div class="difficulty-dots">
                  <div class="difficulty-dot active"></div><div class="difficulty-dot"></div><div class="difficulty-dot"></div>
                </div>
              </div>
            </div>
            <div class="challenge-badge weekly">Weekly</div>
          </div>

          <p class="challenge-description">
            Start each day with 10 minutes of movement to boost energy and mental clarity. Choose from stretching, yoga, or light cardio.
          </p>

          <div class="challenge-stats">
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="morning-energy-participants">0</span>
              <span class="challenge-stat-label">Participants</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="morning-energy-days">4</span>
              <span class="challenge-stat-label">Days Left</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">150</span>
              <span class="challenge-stat-label">Points</span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-header">
              <span class="progress-text">Your Progress</span>
              <span class="progress-percentage" id="morning-energy-progress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="morning-energy-fill" style="width:0%"></div>
            </div>
          </div>

          <div class="challenge-actions">
            <button class="btn btn-primary" id="morning-energy-btn" onclick="joinChallenge('morning-energy')">Join Challenge</button>
            <button class="progress-btn" id="morning-energy-progress-btn" onclick="logProgress('morning-energy')" style="display:none;">Log Progress</button>
            <button class="btn btn-secondary" onclick="viewChallenge('morning-energy')" title="View Details"><i class="fas fa-info"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mental -->
    <div class="challenge-section fade-in-up">
      <div class="section-header">
        <div>
          <h2 class="section-title"><i class="fas fa-brain"></i>Mental Focus & Resilience</h2>
          <p class="section-description">Develop concentration, stress resilience, and mental toughness for peak cognitive performance</p>
        </div>
      </div>

      <div class="challenges-grid">
        <!-- Deep Work -->
        <div class="challenge-card" data-challenge="deep-work">
          <div class="challenge-header">
            <div class="challenge-info">
              <h3>Deep Work Mastery</h3>
              <div class="challenge-difficulty">
                <span>Intermediate</span>
                <div class="difficulty-dots">
                  <div class="difficulty-dot active"></div><div class="difficulty-dot active"></div><div class="difficulty-dot"></div>
                </div>
              </div>
            </div>
            <div class="challenge-badge weekly">Weekly</div>
          </div>

          <p class="challenge-description">
            Complete 90-minute focused work sessions without distractions. Build the concentration skills that separate high performers from the rest.
          </p>

          <div class="challenge-stats">
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="deep-work-participants">0</span>
              <span class="challenge-stat-label">Participants</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="deep-work-days">2</span>
              <span class="challenge-stat-label">Days Left</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">200</span>
              <span class="challenge-stat-label">Points</span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-header">
              <span class="progress-text">Your Progress</span>
              <span class="progress-percentage" id="deep-work-progress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="deep-work-fill" style="width:0%"></div>
            </div>
          </div>

          <div class="challenge-actions">
            <button class="btn btn-primary" id="deep-work-btn" onclick="joinChallenge('deep-work')">Join Challenge</button>
            <button class="progress-btn" id="deep-work-progress-btn" onclick="logProgress('deep-work')" style="display:none;">Log Progress</button>
            <button class="btn btn-secondary" onclick="viewChallenge('deep-work')" title="View Details"><i class="fas fa-info"></i></button>
          </div>
        </div>

        <!-- Stress Resilience -->
        <div class="challenge-card" data-challenge="stress-resilience">
          <div class="challenge-header">
            <div class="challenge-info">
              <h3>Stress Resilience Training</h3>
              <div class="challenge-difficulty">
                <span>Beginner</span>
                <div class="difficulty-dots">
                  <div class="difficulty-dot active"></div><div class="difficulty-dot"></div><div class="difficulty-dot"></div>
                </div>
              </div>
            </div>
            <div class="challenge-badge ongoing">Ongoing</div>
          </div>

          <p class="challenge-description">
            Build mental resilience through daily mindfulness practice and stress management techniques. Learn to perform under pressure.
          </p>

          <div class="challenge-stats">
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="stress-resilience-participants">0</span>
              <span class="challenge-stat-label">Participants</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">∞</span>
              <span class="challenge-stat-label">Duration</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">10</span>
              <span class="challenge-stat-label">Daily Points</span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-header">
              <span class="progress-text">This Week</span>
              <span class="progress-percentage" id="stress-resilience-progress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="stress-resilience-fill" style="width:0%"></div>
            </div>
          </div>

          <div class="challenge-actions">
            <button class="btn btn-primary" id="stress-resilience-btn" onclick="joinChallenge('stress-resilience')">Join Challenge</button>
            <button class="progress-btn" id="stress-resilience-progress-btn" onclick="logProgress('stress-resilience')" style="display:none;">Log Progress</button>
            <button class="btn btn-secondary" onclick="viewChallenge('stress-resilience')" title="View Details"><i class="fas fa-info"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Excellence Habits -->
    <div class="challenge-section fade-in-up">
      <div class="section-header">
        <div>
          <h2 class="section-title"><i class="fas fa-chart-line"></i>Excellence Habits</h2>
          <p class="section-description">Master the daily systems and routines of high achievers for sustained excellence</p>
        </div>
      </div>
      <div class="challenges-grid">
        <!-- Elite Morning -->
        <div class="challenge-card featured" data-challenge="elite-morning">
          <div class="challenge-header">
            <div class="challenge-info">
              <h3>Elite Morning Routine</h3>
              <div class="challenge-difficulty">
                <span>Advanced</span>
                <div class="difficulty-dots">
                  <div class="difficulty-dot active"></div><div class="difficulty-dot active"></div><div class="difficulty-dot active"></div>
                </div>
              </div>
            </div>
            <div class="challenge-badge monthly">Monthly</div>
          </div>

          <p class="challenge-description">
            Master the morning routine of high performers: exercise, planning, learning, and focused work within the first 3 hours of your day.
          </p>

          <div class="challenge-stats">
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="elite-morning-participants">0</span>
              <span class="challenge-stat-label">Participants</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="elite-morning-days">18</span>
              <span class="challenge-stat-label">Days Left</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">750</span>
              <span class="challenge-stat-label">Points</span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-header">
              <span class="progress-text">Your Progress</span>
              <span class="progress-percentage" id="elite-morning-progress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="elite-morning-fill" style="width:0%"></div>
            </div>
          </div>

          <div class="challenge-actions">
            <button class="btn btn-primary" id="elite-morning-btn" onclick="joinChallenge('elite-morning')">Join Challenge</button>
            <button class="progress-btn" id="elite-morning-progress-btn" onclick="logProgress('elite-morning')" style="display:none;">Log Progress</button>
            <button class="btn btn-secondary" onclick="viewChallenge('elite-morning')" title="View Details"><i class="fas fa-info"></i></button>
          </div>
        </div>

        <!-- Time Mastery -->
        <div class="challenge-card" data-challenge="time-mastery">
          <div class="challenge-header">
            <div class="challenge-info">
              <h3>Time Mastery Challenge</h3>
              <div class="challenge-difficulty">
                <span>Intermediate</span>
                <div class="difficulty-dots">
                  <div class="difficulty-dot active"></div><div class="difficulty-dot active"></div><div class="difficulty-dot"></div>
                </div>
              </div>
            </div>
            <div class="challenge-badge weekly">Weekly</div>
          </div>

          <p class="challenge-description">
            Track every hour and optimize your time allocation. Identify time wasters and maximize high-impact activities like top performers.
          </p>

          <div class="challenge-stats">
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="time-mastery-participants">0</span>
              <span class="challenge-stat-label">Participants</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value" id="time-mastery-days">5</span>
              <span class="challenge-stat-label">Days Left</span>
            </div>
            <div class="challenge-stat">
              <span class="challenge-stat-value">300</span>
              <span class="challenge-stat-label">Points</span>
            </div>
          </div>

          <div class="challenge-progress">
            <div class="progress-header">
              <span class="progress-text">Your Progress</span>
              <span class="progress-percentage" id="time-mastery-progress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="time-mastery-fill" style="width:0%"></div>
            </div>
          </div>

          <div class="challenge-actions">
            <button class="btn btn-primary" id="time-mastery-btn" onclick="joinChallenge('time-mastery')">Join Challenge</button>
            <button class="progress-btn" id="time-mastery-progress-btn" onclick="logProgress('time-mastery')" style="display:none;">Log Progress</button>
            <button class="btn btn-secondary" onclick="viewChallenge('time-mastery')" title="View Details"><i class="fas fa-info"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overall Performance Leaderboard -->
  <div class="leaderboard fade-in-up">
    <div class="leaderboard-header">
      <h2 class="section-title"><i class="fas fa-trophy"></i>Overall Performance Leaderboard</h2>
      <button class="btn btn-secondary" onclick="viewFullLeaderboard()" title="View Full Leaderboard"><i class="fas fa-external-link-alt"></i></button>
    </div>
    <div class="leaderboard-list" id="leaderboardList"></div>
  </div>
</main>

<script>
/** -----------------------------
 *  Global Leaderboard Manager
 *  ----------------------------*/
class LeaderboardManager {
  constructor() {
    this.leaderboards = {
      overall: [],
      challenges: [],
      physical: [],
      mental: [],
      habits: [],
      weekly: [],
      monthly: []
    };
    this.currentUser = null;
    this.refreshInterval = null;
  }

  async initialize(userId, userName) {
    this.currentUser = { userId, displayName: userName };
    await this.fetchAllLeaderboards();
    this.startAutoRefresh();
  }

  async fetchAllLeaderboards() {
    try {
      // Fetch all leaderboard types
      const responses = await Promise.allSettled([
        fetch('https://vivify-backend.onrender.com/api/leaderboard/overall'),
        fetch('https://vivify-backend.onrender.com/api/leaderboard/challenges'),
        fetch('https://vivify-backend.onrender.com/api/leaderboard/physical'),
        fetch('https://vivify-backend.onrender.com/api/leaderboard/mental'),
        fetch('https://vivify-backend.onrender.com/api/leaderboard/habits'),
        fetch('https://vivify-backend.onrender.com/api/leaderboard/weekly'),
        fetch('https://vivify-backend.onrender.com/api/leaderboard/monthly')
      ]);

      const types = ['overall', 'challenges', 'physical', 'mental', 'habits', 'weekly', 'monthly'];
      
      for (let i = 0; i < responses.length; i++) {
        if (responses[i].status === 'fulfilled' && responses[i].value.ok) {
          this.leaderboards[types[i]] = await responses[i].value.json();
        } else {
          console.warn(`Failed to fetch ${types[i]} leaderboard`);
          this.leaderboards[types[i]] = [];
        }
      }
    } catch (error) {
      console.error('Failed to fetch leaderboards:', error);
    }
  }

  async updateUserProgress(challengeId, progress) {
    try {
      const response = await fetch('https://vivify-backend.onrender.com/api/user/progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: this.currentUser.userId,
          challengeId,
          progress,
          timestamp: new Date().toISOString()
        })
      });

      if (response.ok) {
        // Refresh leaderboards after progress update
        await this.fetchAllLeaderboards();
        this.updateDisplays();
        return true;
      }
    } catch (error) {
      console.error('Failed to update progress:', error);
    }
    return false;
  }

  getChallengeLeaderboard(challengeId) {
    // Get leaderboard specific to a challenge
    return this.leaderboards.challenges.filter(entry => 
      entry.challengeId === challengeId
    ).sort((a, b) => (b.progress || 0) - (a.progress || 0));
  }

  getCategoryLeaderboard(category) {
    // Get leaderboard for challenge categories
    return this.leaderboards[category] || [];
  }

  getOverallLeaderboard() {
    return this.leaderboards.overall || [];
  }

  getUserRank(leaderboardType = 'overall') {
    const board = this.leaderboards[leaderboardType] || [];
    const userIndex = board.findIndex(entry => 
      entry.userId === this.currentUser?.userId
    );
    return userIndex === -1 ? null : userIndex + 1;
  }

  getUserScore(leaderboardType = 'overall') {
    const board = this.leaderboards[leaderboardType] || [];
    const userEntry = board.find(entry => 
      entry.userId === this.currentUser?.userId
    );
    return userEntry?.score || 0;
  }

  updateDisplays() {
    this.updateMainLeaderboard();
    this.updateChallengeStats();
    this.updateUserRankings();
  }

  updateMainLeaderboard() {
    const list = document.getElementById('leaderboardList');
    if (!list) return;

    const overallBoard = this.getOverallLeaderboard();
    if (overallBoard.length === 0) {
      list.innerHTML = '<p style="color:rgba(255,255,255,.7);text-align:center;padding:2rem;">Loading leaderboard...</p>';
      return;
    }

    list.innerHTML = '';
    const top10 = overallBoard.slice(0, 10);

    top10.forEach((entry, idx) => {
      const item = document.createElement('div');
      item.className = 'leaderboard-item';
      if (entry.userId === this.currentUser?.userId) {
        item.classList.add('current-user');
      }

      let icon = '<i class="fas fa-user"></i>';
      if (idx === 0) icon = '<i class="fas fa-crown" style="color:#f39c12;"></i>';
      else if (idx === 1) icon = '<i class="fas fa-medal" style="color:#c0c0c0;"></i>';
      else if (idx === 2) icon = '<i class="fas fa-medal" style="color:#cd7f32;"></i>';

      const isCurrentUser = entry.userId === this.currentUser?.userId;
      const displayName = entry.displayName || 'Student';

      item.innerHTML = `
        <div class="leaderboard-rank">${idx + 1}</div>
        <div class="leaderboard-avatar">${icon}</div>
        <div class="leaderboard-info">
          <div class="leaderboard-name">${displayName}${isCurrentUser ? ' (You)' : ''}</div>
          <div class="leaderboard-school">${entry.school || ''}</div>
        </div>
        <div class="overall-score">
          <div class="leaderboard-score">${(entry.overallScore || 0).toLocaleString()}</div>
          <div class="level-badge">Level ${entry.level || 1}</div>
        </div>`;
      
      list.appendChild(item);
    });
  }

  updateChallengeStats() {
    // Update hero stats with real data
    const userOverall = this.getOverallLeaderboard().find(u => 
      u.userId === this.currentUser?.userId
    );

    if (userOverall) {
      const activeEl = document.getElementById('activeChallenges');
      const completedEl = document.getElementById('completedChallenges');
      const pointsEl = document.getElementById('totalPoints');

      if (activeEl) activeEl.textContent = userOverall.activeChallenges || 0;
      if (completedEl) completedEl.textContent = userOverall.completedChallenges || 0;
      if (pointsEl) pointsEl.textContent = userOverall.totalPoints || 0;
    }
  }

  updateUserRankings() {
    // Show user's ranking in different categories
    const rankings = {
      overall: this.getUserRank('overall'),
      physical: this.getUserRank('physical'),
      mental: this.getUserRank('mental'),
      habits: this.getUserRank('habits')
    };

    console.log('User rankings:', rankings);
  }

  startAutoRefresh() {
    // Refresh leaderboards every 30 seconds
    this.refreshInterval = setInterval(async () => {
      await this.fetchAllLeaderboards();
      this.updateDisplays();
    }, 30000);
  }

  stopAutoRefresh() {
    if (this.refreshInterval) {
      clearInterval(this.refreshInterval);
      this.refreshInterval = null;
    }
  }

  // Challenge-specific leaderboard methods
  async showChallengeLeaderboard(challengeId) {
    const challengeBoard = this.getChallengeLeaderboard(challengeId);
    const challenge = challenges[challengeId];
    
    if (!challenge) return;

    let html = `<h3>${challenge.name} Leaderboard</h3><div class="mini-leaderboard">`;
    
    if (challengeBoard.length === 0) {
      html += '<p>No participants yet. Be the first!</p>';
    } else {
      challengeBoard.slice(0, 5).forEach((entry, idx) => {
        const isCurrentUser = entry.userId === this.currentUser?.userId;
        html += `
          <div class="mini-leaderboard-item ${isCurrentUser ? 'current-user' : ''}">
            <span class="rank">${idx + 1}.</span>
            <span class="name">${entry.displayName}${isCurrentUser ? ' (You)' : ''}</span>
            <span class="progress">${entry.progress || 0}%</span>
          </div>`;
      });
    }
    
    html += '</div>';
    showNotification(html, 'info');
  }

  async updateChallengeParticipants() {
    // Update participant counts for each challenge
    Object.keys(challenges).forEach(challengeId => {
      const participants = this.getChallengeLeaderboard(challengeId).length;
      const el = document.getElementById(`${challengeId}-participants`);
      if (el) el.textContent = participants.toLocaleString();
    });
  }
}

// Global instance
const leaderboardManager = new LeaderboardManager();

/** -----------------------------
 *  State Management
 *  ----------------------------*/
let userId = null;
let currentUserName = null;
let userChallenges = {};
let challengeStats = { active: 0, completed: 0, totalPoints: 0 };

// Challenge catalog
const challenges = {
  'fitness-foundation': { name:'30-Day Fitness Foundation', type:'monthly', category:'physical', duration:30, points:500, requirements:['Complete 30 minutes of physical activity daily','Track workout intensity','Log energy levels'], goalType:'daily', totalGoal:30 },
  'morning-energy':     { name:'Morning Energy Boost',      type:'weekly',  category:'physical', duration:7,  points:150, requirements:['10 minutes morning movement','Before 8 AM','Track energy levels'], goalType:'daily', totalGoal:7 },
  'deep-work':          { name:'Deep Work Mastery',         type:'weekly',  category:'mental',   duration:7,  points:200, requirements:['90-minute focused sessions','No distractions','Track productivity'], goalType:'daily', totalGoal:7 },
  'stress-resilience':  { name:'Stress Resilience Training',type:'ongoing', category:'mental',   duration:'ongoing', points:10, requirements:['Daily mindfulness practice','Stress management techniques','Mood tracking'], goalType:'daily', totalGoal:7 },
  'elite-morning':      { name:'Elite Morning Routine',     type:'monthly', category:'habits',   duration:30, points:750, requirements:['Exercise within 3 hours','Planning session','Learning time','Focused work'], goalType:'daily', totalGoal:30 },
  'time-mastery':       { name:'Time Mastery Challenge',    type:'weekly',  category:'habits',   duration:7,  points:300, requirements:['Track every hour','Identify time wasters','Optimize high-impact activities'], goalType:'daily', totalGoal:7 }
};

const achievementDefinitions = {
  first_challenge: { name: 'First Challenge', description: 'Complete your first challenge', icon: '🏆' },
  challenge_veteran: { name: 'Challenge Veteran', description: 'Complete 5 challenges', icon: '🎖️' },
  challenge_master: { name: 'Challenge Master', description: 'Complete 10 challenges', icon: '👑' },
  week_warrior: { name: 'Week Warrior', description: '7-day habit streak', icon: '⚡' },
  month_master: { name: 'Month Master', description: '30-day habit streak', icon: '🔥' },
  century_streak: { name: 'Century Streak', description: '100-day streak', icon: '💯' },
  rising_star: { name: 'Rising Star', description: 'Reach 500 points', icon: '⭐' },
  high_achiever: { name: 'High Achiever', description: 'Reach 1000 points', icon: '🚀' },
  elite_performer: { name: 'Elite Performer', description: 'Reach 2500 points', icon: '💎' },
  habit_builder: { name: 'Habit Builder', description: 'Earn 300 habit points', icon: '🧱' },
  habit_master: { name: 'Habit Master', description: 'Earn 1000 habit points', icon: '🎯' }
};

/** -----------------------------
 *  Helper Functions
 *  ----------------------------*/
function showNotification(message, type='info'){
  const n=document.createElement('div');
  n.className=`notification ${type}`;
  n.style.whiteSpace='pre-line';
  n.innerHTML=message; // Using innerHTML to support HTML content for leaderboards
  document.body.appendChild(n);
  setTimeout(()=>n.classList.add('show'),100);
  setTimeout(()=>{n.classList.remove('show'); setTimeout(()=>n.remove(),300);},7000); // Longer display for leaderboards
}

function getLoggedInUser() {
  // Use your existing auth data
  const userLoggedIn = localStorage.getItem('userLoggedIn');
  const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
  const username = localStorage.getItem('username');
  
  if (userLoggedIn === 'true' && userProfile.id && username) {
    return {
      userId: userProfile.id, // This is Isaac's real MongoDB _id
      username: username,     // This is "Isaac"
      isLoggedIn: true
    };
  }
  
  // If not logged in, redirect to login
  window.location.href = 'login.html';
  return null;
}

/** -----------------------------
 *  Backend I/O
 *  ----------------------------*/
 async function fetchUser(){
  try{
    const res=await fetch(`https://vivify-backend.onrender.com/api/user/${userId}`);
    if(!res.ok) throw new Error('User not found');
    const data=await res.json();
    
    currentUserName = data.username || data.displayName || 'You';
    userChallenges = data.userChallenges || {};
    userChallengeStats = data.challengeStats || {active:0, completed:0, totalPoints:0};
    userOverallScore = data.overallScore || 0; // Store the real overall score

    console.log('Stored values:', { // Debug log
      challengeStats: userChallengeStats,
      overallScore: userOverallScore
    });
    
    
    // Store actual database scores
    userLevel = data.level || 1;
    userHabitStreak = data.habitStreak || 0;
    userFitnessScore = data.fitnessScore || 0;
    userNutritionScore = data.nutritionScore || 0;
    userMentalScore = data.mentalScore || 0;
    userLifeSkillsScore = data.lifeSkillsScore || 0;
    userOverallScore = data.overallScore || 0;
    
    // Display achievements
    const achievements = data.achievements || [];
    displayAchievements(achievements);
  }catch(e){
    // Initialize with defaults for new users...
  }
}

async function saveUser(){
  try{
    const computed = computeCurrentUserSummary();
    await fetch(`https://vivify-backend.onrender.com/api/user/${userId}`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        userId, displayName: currentUserName,
        userChallenges, challengeStats,
        overallScore: computed.overallScore,
        level: computed.level,
        habitStreak: computed.habitStreak,
        fitnessScore: computed.fitnessScore,
        nutritionScore: computed.nutritionScore,
        mentalScore: computed.mentalScore,
        lifeSkillsScore: computed.lifeSkillsScore
      })
    });
  }catch(e){ console.error('Failed to save user',e); }
}

/** -----------------------------
 *  Scoring Logic
 *  ----------------------------*/
function calculateOverallScore(user){
  const challengeMultiplier=1.0, habitMultiplier=0.8, fitnessMultiplier=0.6, nutritionMultiplier=0.6, mentalMultiplier=0.7, lifeSkillsMultiplier=0.5;
  const levelBonus=(user.level||1)*50;
  return Math.round(
    (user.challengePoints||0)*challengeMultiplier +
    (user.habitStreak||0)*habitMultiplier +
    (user.fitnessScore||0)*fitnessMultiplier +
    (user.nutritionScore||0)*nutritionMultiplier +
    (user.mentalScore||0)*mentalMultiplier +
    (user.lifeSkillsScore||0)*lifeSkillsMultiplier +
    levelBonus
  );
}

function computeCurrentUserSummary(){
  // Use actual database values instead of calculating from challengeStats
  return {
    challengePoints: challengeStats.totalPoints || 0,
    level: userLevel || 1,
    habitStreak: userHabitStreak || 0,
    fitnessScore: userFitnessScore || 0,
    nutritionScore: userNutritionScore || 0,
    mentalScore: userMentalScore || 0,
    lifeSkillsScore: userLifeSkillsScore || 0,
    overallScore: userOverallScore || 0
  };
}

function updateChallengeStats(){
  // Use actual database values instead of calculating
  const active = userChallengeStats?.active || 0;
  const completed = userChallengeStats?.completed || 0;
  const totalPoints = userOverallScore || 0; // Use overall score, not just challenge points

  console.log('Updating stats with:', { active, completed, totalPoints }); // Debug log

  const a = document.getElementById('activeChallenges');
  const c = document.getElementById('completedChallenges');
  const p = document.getElementById('totalPoints');
  
  if(a) a.textContent = active;
  if(c) c.textContent = completed;
  if(p) p.textContent = totalPoints;
}

function updateAllChallengeCards(){
  Object.keys(challenges).forEach(updateChallengeCard);
}

function updateChallengeCard(challengeId){
  const uc=userChallenges[challengeId]; const ch=challenges[challengeId];
  const btn=document.getElementById(`${challengeId}-btn`);
  const pbtn=document.getElementById(`${challengeId}-progress-btn`);
  const fill=document.getElementById(`${challengeId}-fill`);
  const text=document.getElementById(`${challengeId}-progress`);
  if(!btn||!ch) return;

  if(uc?.joined){
    if(uc.completed){
      btn.textContent='Completed ✓'; btn.className='btn completed'; btn.disabled=true; if(pbtn) pbtn.style.display='none';
    }else{
      btn.textContent='In Progress'; btn.className='btn in-progress'; btn.disabled=true; if(pbtn) pbtn.style.display='inline-block';
    }
    const progress=calcProgress(challengeId);
    if(fill) fill.style.width=progress+'%';
    if(text) text.textContent=progress+'%';
  }else{
    btn.textContent='Join Challenge'; btn.className='btn btn-primary'; btn.disabled=false;
    if(pbtn) pbtn.style.display='none';
    if(fill) fill.style.width='0%';
    if(text) text.textContent='0%';
  }
}

function calcProgress(challengeId){
  const uc=userChallenges[challengeId]; const ch=challenges[challengeId];
  if(!uc?.joined||!ch) return 0;
  if(ch.type==='ongoing') return Math.min(100, Math.round((uc.dailyProgress||0)/7*100));
  return Math.min(100, Math.round((uc.completedDays||0)/(ch.totalGoal||1)*100));
}

/** -----------------------------
 *  Enhanced Challenge Actions
 *  ----------------------------*/
async function joinChallenge(challengeId) {
  const ch = challenges[challengeId];
  if (!ch) return showNotification('Challenge not found', 'error');

  if (userChallenges[challengeId]?.joined) {
    showNotification('You are already in this challenge', 'info');
    return;
  }

  // Update local state
  userChallenges[challengeId] = {
    joined: true,
    startDate: new Date().toISOString(),
    completedDays: 0,
    dailyProgress: 0,
    completed: false,
    lastLogDate: null
  };

  // Update backend
  const success = await leaderboardManager.updateUserProgress(challengeId, {
    action: 'join',
    progress: 0
  });

  if (success) {
    updateChallengeStats();
    updateChallengeCard(challengeId);
    await saveUser();
    showNotification(`Joined ${ch.name}!`, 'success');
    
    // Update participant count
    leaderboardManager.updateChallengeParticipants();
  } else {
    showNotification('Failed to join challenge. Please try again.', 'error');
  }
}

async function logProgress(challengeId) {
  const ch = challenges[challengeId];
  const uc = userChallenges[challengeId];
  
  if (!ch || !uc?.joined) {
    return showNotification('Join the challenge first', 'info');
  }

  const today = new Date().toDateString();
  if (uc.lastLogDate === today) {
    return showNotification('Already logged today', 'info');
  }

  uc.lastLogDate = today;

  let progressUpdate;
  if (ch.type === 'ongoing') {
    uc.dailyProgress = (uc.dailyProgress || 0) + 1;
    challengeStats.totalPoints += ch.points;
    progressUpdate = {
      action: 'daily_progress',
      dailyProgress: uc.dailyProgress,
      points: ch.points
    };
    showNotification(`Progress logged! +${ch.points} points`, 'success');
  } else {
    uc.completedDays = (uc.completedDays || 0) + 1;
    const progressPercent = Math.round((uc.completedDays / (ch.totalGoal || 1)) * 100);
    
    if (uc.completedDays >= (ch.totalGoal || 0)) {
      uc.completed = true;
      challengeStats.totalPoints += ch.points;
      progressUpdate = {
        action: 'complete',
        completedDays: uc.completedDays,
        points: ch.points,
        progress: 100
      };
      showNotification(`Challenge completed! +${ch.points} points`, 'success');
    } else {
      progressUpdate = {
        action: 'progress',
        completedDays: uc.completedDays,
        progress: progressPercent
      };
      showNotification('Daily progress logged! Keep going!', 'success');
    }
  }

  // Update backend and refresh leaderboards
  const success = await leaderboardManager.updateUserProgress(challengeId, progressUpdate);
  
  if (success) {
    updateChallengeStats();
    updateChallengeCard(challengeId);
    await saveUser();
  } else {
    showNotification('Failed to log progress. Please try again.', 'error');
  }
}

function viewChallenge(challengeId) {
  const ch = challenges[challengeId];
  if (!ch) return;

  // Show challenge details AND leaderboard
  leaderboardManager.showChallengeLeaderboard(challengeId);
}

async function viewFullLeaderboard(){
  try {
    // Fetch the current user's actual data from the backend
    const response = await fetch(`/api/user/${userId}`);
    if (!response.ok) {
      showNotification('Unable to load score breakdown', 'error');
      return;
    }
    
    const userData = await response.json();
    
    // Use real data from the backend
    const breakdown = {
      challengePoints: userData.challengeStats?.totalPoints || 0,
      habitPoints: userData.habitPoints || 0,
      currentStreak: userData.currentStreak || 0,
      streakBonus: Math.floor((userData.currentStreak || 0) / 7) * 50,
      fitnessScore: userData.fitnessScore || 0,
      nutritionScore: userData.nutritionScore || 0,
      mentalScore: userData.mentalScore || 0,
      lifeSkillsScore: userData.lifeSkillsScore || 0,
      level: userData.level || 1,
      levelBonus: (userData.level || 1) * 50,
      overallScore: userData.overallScore || 0
    };

    showNotification(
      `Your Overall Score Breakdown:
- Challenge Points: ${breakdown.challengePoints}
- Habit Points: ${breakdown.habitPoints}
- Current Streak: ${breakdown.currentStreak} days
- Streak Bonus: ${breakdown.streakBonus}
- Fitness Score: ${breakdown.fitnessScore}
- Nutrition Score: ${breakdown.nutritionScore}
- Mental Score: ${breakdown.mentalScore}
- Life Skills Score: ${breakdown.lifeSkillsScore}
- Level Bonus: ${breakdown.levelBonus} (Level ${breakdown.level})

Total Score: ${breakdown.overallScore}`,
      'info'
    );
  } catch (error) {
    console.error('Error fetching score breakdown:', error);
    showNotification('Unable to load score breakdown', 'error');
  }
}

function filterChallenges(filter){
  document.querySelectorAll('.challenge-card').forEach(card=>{
    if(filter==='all'){ card.style.display='block'; return; }
    if(filter==='featured'){ card.style.display=card.classList.contains('featured')?'block':'none'; return; }
    const badge=card.querySelector('.challenge-badge'); const text=badge?badge.textContent.toLowerCase():'';
    card.style.display = text===filter ? 'block' : 'none';
  });
}

function displayAchievements(userAchievements = []) {
  const grid = document.getElementById('achievementsGrid');
  if (!grid) return;
  
  grid.innerHTML = '';
  
  Object.entries(achievementDefinitions).forEach(([key, achievement]) => {
    const isUnlocked = userAchievements.includes(key);
    
    const card = document.createElement('div');
    card.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
    
    card.innerHTML = `
      <span class="achievement-icon">${achievement.icon}</span>
      <div class="achievement-name">${achievement.name}</div>
      <div class="achievement-description">${achievement.description}</div>
    `;
    
    grid.appendChild(card);
  });
}

/** -----------------------------
 *  Initialization
 *  ----------------------------*/

 document.addEventListener('DOMContentLoaded', async () => {
  // Logout functionality
  const logout=document.getElementById('logout-link');
  if(logout){ logout.addEventListener('click',e=>{e.preventDefault(); localStorage.clear(); window.location.href='index.html';}); }

  // Filter tabs
  document.querySelectorAll('.filter-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      filterChallenges(tab.dataset.filter);
    });
  });

  // Animations
  const obs=new IntersectionObserver((ents)=>{
    ents.forEach(ent=>{ if(ent.isIntersecting){ ent.target.style.opacity='1'; ent.target.style.transform='translateY(0)'; } });
  },{threshold:.1,rootMargin:'0px 0px -50px 0px'});
  document.querySelectorAll('.fade-in-up').forEach(el=>{
    el.style.opacity='0'; el.style.transform='translateY(30px)'; el.style.transition='opacity .8s ease, transform .8s ease'; obs.observe(el);
  });

  // Initialize user and system
  const loggedInUser = getLoggedInUser();
  if (!loggedInUser) return;
  
  userId = loggedInUser.userId;
  currentUserName = loggedInUser.username;

  // Initialize enhanced leaderboard system
  await leaderboardManager.initialize(userId, currentUserName);

  await fetchUser();
  updateChallengeStats();
  updateAllChallengeCards();

  // The leaderboard manager handles all leaderboard updates
  leaderboardManager.updateDisplays();
  leaderboardManager.updateChallengeParticipants();
});

// Clean up on page unload
window.addEventListener('beforeunload', () => {
  leaderboardManager.stopAutoRefresh();
});

// Optional: track page visit
if(window.vivifyTracker){
  window.vivifyTracker.trackActivity('challenges_visit','challenges','Visited challenges page',5);
}
</script>
<script src="js/flexible-mobile-nav.js"></script> </body>
</html>